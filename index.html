<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—æ”¶æ”¯å¡«å ±èˆ‡åŒ¯æ•´ç³»çµ± (v3.1.5 å…¨åŠŸèƒ½ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        
        /* --- Tooltip æ¨£å¼ --- */
        .btn-tooltip { position: relative; }
        .btn-tooltip::after {
            content: attr(data-tooltip);
            position: absolute; top: 125%; left: 50%; transform: translateX(-50%);
            background-color: #1e293b; color: #fff; padding: 6px 10px; border-radius: 6px;
            font-size: 0.75rem; white-space: nowrap; opacity: 0; visibility: hidden;
            transition: all 0.2s ease-in-out; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-tooltip:hover::after { opacity: 1; visibility: visible; top: 115%; }

        /* --- è¼¸å…¥æ¡† Excel è²¼ä¸Šæç¤º --- */
        [data-input-tip] { position: relative; }
        [data-input-tip]:hover::after {
            content: attr(data-input-tip);
            position: absolute; bottom: 100%; left: 0;
            background: #334155; color: white; padding: 3px 8px; border-radius: 4px;
            font-size: 0.7rem; white-space: nowrap; z-index: 100; pointer-events: none;
        }

        /* --- å°è¦½åˆ— --- */
        .nav-container { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        .tab-pill-container { background-color: #f1f5f9; padding: 4px; border-radius: 9999px; display: inline-flex; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); }
        .tab-btn { padding: 8px 24px; border-radius: 9999px; font-weight: 600; font-size: 0.95rem; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background-color: white; color: #0f172a; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- è¡¨æ ¼ --- */
        .budget-table th { background-color: #e2e8f0; padding: 8px; font-size: 0.85rem; border: 1px solid #cbd5e1; white-space: nowrap; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 100px; }
        .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
        .budget-table .name-input { text-align: left; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
        .budget-table input[readonly] { font-weight: bold; color: #2563eb; background-color: #f8fafc; }
        
        .agg-table th { background-color: #334155; color: #94a3b8; padding: 12px; font-size: 0.85rem; text-align: left; }
        .agg-table td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.9rem; color: #e2e8f0; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable::after { content: ' â†•'; opacity: 0.3; float: right; }

        .drop-zone { border: 3px dashed #475569; transition: all 0.3s; background-color: #1e293b; }
        .drop-zone.active { border-color: #38bdf8; background-color: #334155; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
    </style>
</head>
<body>

<nav class="nav-container sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl">ğŸ‡¹ğŸ‡¼</div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">æ”¿åºœé ç®—è³‡æ–™æŸ¥å¡«å¹³è‡º</h1>
                <p class="text-xs text-slate-500">v3.1.5 (å…¨åŠŸèƒ½ & è²¼ä¸Šæ”¯æ´)</p>
            </div>
        </div>
        <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:block">
            <div class="tab-pill-container">
                <button onclick="switchTab('guide')" id="btn-guide" class="tab-btn active">ğŸ“– ä½¿ç”¨æŒ‡å—</button>
                <button onclick="switchTab('manager')" id="btn-manager" class="tab-btn">ğŸ“ å¡«å ±å·¥ä½œç«™</button>
                <button onclick="switchTab('aggregator')" id="btn-aggregator" class="tab-btn">ğŸ“Š åŒ¯æ•´å„€è¡¨æ¿</button>
            </div>
        </div>
    </div>
</nav>

<div id="tab-guide" class="max-w-5xl mx-auto p-8 block">
    <div class="bg-white rounded-3xl shadow-xl p-12 border border-slate-100">
        <h2 class="text-3xl font-extrabold text-slate-800 mb-8 text-center">æ­¡è¿ä½¿ç”¨é ç®—è³‡æ–™æŸ¥å¡«å¹³è‡º</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div onclick="switchTab('manager')" class="group cursor-pointer bg-blue-50 p-8 rounded-2xl border-2 border-transparent hover:border-blue-300 transition-all">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-blue-100 p-3 rounded-full text-2xl">ğŸ“</div>
                    <h3 class="text-xl font-bold text-blue-900">æˆ‘æ˜¯å¡«å ±å–®ä½</h3>
                </div>
                <p class="text-slate-600 mb-6 font-medium">æ”¯æ´ Excel è·¨åˆ—è¤‡è£½è²¼ä¸Šï¼Œè‡ªå‹•è¨ˆç®—ç›ˆè™§èˆ‡è§£ç¹³å…¬åº«æ•¸ã€‚</p>
                <div class="mt-6 text-blue-600 font-bold text-sm">å‰å¾€å¡«å ± &rarr;</div>
            </div>
            <div onclick="switchTab('aggregator')" class="group cursor-pointer bg-indigo-50 p-8 rounded-2xl border-2 border-transparent hover:border-indigo-300 transition-all">
                <div class="flex items-center gap-4 mb-4">
                    <div class="bg-indigo-100 p-3 rounded-full text-2xl">ğŸ“Š</div>
                    <h3 class="text-xl font-bold text-indigo-900">æˆ‘æ˜¯åŒ¯æ•´å–®ä½</h3>
                </div>
                <p class="text-slate-600 mb-6 font-medium">è¦–è¦ºåŒ– KPI å„€è¡¨æ¿ï¼Œæ”¯æ´å¤šæª”æ¡ˆæ‹–æ›³åŒ¯å…¥èˆ‡å–®ä½æ©«å‘æ¯”è¼ƒã€‚</p>
                <div class="mt-6 text-indigo-600 font-bold text-sm">å‰å¾€å„€è¡¨æ¿ &rarr;</div>
            </div>
        </div>
    </div>
</div>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 hidden mt-4">
    <div class="bg-white p-4 rounded-xl shadow mb-6 flex flex-wrap justify-between items-center gap-4 border border-slate-200">
        <div>
            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                ğŸ“ å¡«å ±å·¥ä½œç«™
                <span class="text-xs font-normal text-blue-600 bg-blue-50 border border-blue-200 px-2 py-1 rounded-full flex items-center gap-1">ğŸ’¡ æ”¯æ´ Excel è²¼ä¸Š</span>
                <span id="mgr-status" class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-1 rounded-full">ğŸŸ¢ è‡ªå‹•å„²å­˜</span>
            </h2>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('mgr-import').click()" class="btn-tooltip bg-gray-100 text-gray-600 px-4 py-2 rounded text-sm font-bold" data-tooltip="åŒ¯å…¥ JSON/HTML èˆŠæª”">ğŸ“‚ åŒ¯å…¥</button>
            <input type="file" id="mgr-import" class="hidden" accept=".json,.html" onchange="mgr_importFile(this)">
            <button onclick="mgr_exportXLSX()" class="btn-tooltip bg-green-600 text-white px-4 py-2 rounded text-sm font-bold" data-tooltip="ç”¢å‡º A-11309 æ­£å¼å ±è¡¨">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_exportJSON()" class="btn-tooltip bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold" data-tooltip="å„²å­˜çµæ§‹åŒ–è³‡æ–™">ğŸ’¾ å„²å­˜è³‡æ–™</button>
            <button onclick="mgr_clearAll()" class="btn-tooltip px-3 py-2 text-red-500 hover:bg-red-50 rounded" data-tooltip="æ¸…ç©ºæ‰€æœ‰æ¬„ä½">ğŸ—‘ï¸</button>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">å–®ä½åç¨±</label><input type="text" id="mgr-org" class="w-full border-b-2 border-slate-200 focus:border-blue-500 outline-none py-2 text-lg font-bold" placeholder="ä¾‹å¦‚ï¼šâ—‹â—‹ç¸£æ”¿åºœ" oninput="mgr_autoSave()"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">å¹´åº¦</label><input type="number" id="mgr-year" value="114" class="w-full border-b-2 border-slate-200 outline-none py-2" oninput="mgr_autoSave()"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">å¡«è¡¨äºº</label><input type="text" id="mgr-user" class="w-full border-b-2 border-slate-200 outline-none py-2" oninput="mgr_autoSave()"></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-blue-800 text-lg">1. ç‡Ÿæ¥­åŸºé‡‘</h3><button onclick="mgr_addOpRow()" class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-sm font-bold">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>ç‡Ÿæ¥­æ”¶å…¥</th><th>ç‡Ÿæ¥­æˆæœ¬</th><th>ç‡Ÿæ¥­æ¯›åˆ©</th><th>ç‡Ÿæ¥­è²»ç”¨</th><th>ç‡Ÿæ¥­åˆ©ç›Š</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>ç¨…å‰æ·¨åˆ©</th><th>æ‰€å¾—ç¨…</th><th>æœ¬æœŸæ·¨åˆ©</th></tr></thead><tbody id="mgr-tbody-op"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-green-800 text-lg">2. ä½œæ¥­åŸºé‡‘</h3><button onclick="mgr_addWkRow()" class="bg-green-50 text-green-600 px-3 py-1 rounded-full text-sm font-bold">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>æ¥­å‹™æ”¶å…¥</th><th>æˆæœ¬è²»ç”¨</th><th>æ¥­å‹™è³¸é¤˜</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>æœ¬æœŸè³¸é¤˜</th></tr></thead><tbody id="mgr-tbody-wk"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-orange-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-orange-800 text-lg">3. å‚µå‹™åŸºé‡‘</h3><button onclick="mgr_addDebtRow()" class="bg-orange-50 text-orange-600 px-3 py-1 rounded-full text-sm font-bold">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="mgr-tbody-debt"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-purple-800 text-lg">4. ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘</h3><button onclick="mgr_addSpRow()" class="bg-purple-50 text-purple-600 px-3 py-1 rounded-full text-sm font-bold">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>è§£ç¹³å…¬åº«</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="mgr-tbody-sp"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-pink-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-pink-800 text-lg">5. è³‡æœ¬è¨ˆç•«åŸºé‡‘</h3><button onclick="mgr_addCapRow()" class="bg-pink-50 text-pink-600 px-3 py-1 rounded-full text-sm font-bold">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="mgr-tbody-cap"></tbody></table></div>
        </div>
    </div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-6 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-6">
        <div><h1 class="text-3xl font-bold mb-1">ğŸ“Š åŒ¯æ•´å„€è¡¨æ¿</h1><p class="text-slate-400">Level 2 å…¨å–®ä½æ•¸æ“šçµ±è¨ˆ</p></div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('agg-input').click()" class="bg-slate-700 px-4 py-2 rounded-lg text-sm font-bold">ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ</button>
            <input type="file" id="agg-input" multiple accept=".json,.html" class="hidden" onchange="agg_handleFiles(this.files)">
            <button onclick="agg_clearAll()" class="bg-red-900/50 text-red-200 px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div id="agg-dropzone" class="drop-zone rounded-xl p-10 text-center cursor-pointer mb-8">
        <p class="text-xl font-bold text-slate-300">ğŸ“¥ æ‹–æ›³å–®ä½ JSON/HTML æª”æ¡ˆè‡³æ­¤</p>
    </div>

    <div id="agg-content" class="hidden space-y-8">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="stat-card border-l-4 border-blue-500">
                <div class="text-slate-400 text-xs font-bold uppercase">åŒ¯æ•´å–®ä½</div>
                <div class="text-2xl font-bold mt-1" id="kpi-govs">0</div>
            </div>
            <div class="stat-card border-l-4 border-green-500">
                <div class="text-slate-400 text-xs font-bold uppercase">ç¸½æ”¶å…¥(å„„)</div>
                <div class="text-2xl font-bold mt-1 text-green-400" id="kpi-rev">0</div>
            </div>
            <div class="stat-card border-l-4 border-emerald-500">
                <div class="text-slate-400 text-xs font-bold uppercase">æœ¬æœŸè³¸é¤˜(å„„)</div>
                <div class="text-2xl font-bold mt-1 text-emerald-400" id="kpi-surplus">0</div>
            </div>
            <div class="stat-card border-l-4 border-red-500">
                <div class="text-slate-400 text-xs font-bold uppercase">è™§æå®¶æ•¸</div>
                <div class="text-2xl font-bold mt-1 text-red-400" id="kpi-loss">0</div>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <select id="agg-filter-gov" class="bg-slate-900 border border-slate-600 rounded-lg p-2 outline-none" onchange="agg_search()"><option value="all">ğŸ¢ æ‰€æœ‰å–®ä½</option></select>
                <input type="text" id="agg-search-txt" placeholder="æœå°‹åŸºé‡‘..." class="bg-slate-900 border border-slate-600 rounded-lg p-2 outline-none" oninput="agg_search()">
                <select id="agg-filter-type" class="bg-slate-900 border border-slate-600 rounded-lg p-2 outline-none" onchange="agg_search()">
                    <option value="all">ğŸ“‚ æ‰€æœ‰é¡å‹</option><option value="op">ç‡Ÿæ¥­</option><option value="wk">ä½œæ¥­</option><option value="debt">å‚µå‹™</option><option value="sp">ç‰¹æ”¶</option><option value="cap">è³‡æœ¬</option>
                </select>
            </div>
            <div class="overflow-x-auto max-h-80 border border-slate-700 rounded-lg">
                <table class="w-full agg-table text-left text-sm">
                    <thead class="sticky top-0 bg-slate-900 z-10 shadow">
                        <tr><th>å–®ä½</th><th>é¡å‹</th><th>åç¨±</th><th class="text-right">ç¸½æ”¶å…¥</th><th class="text-right">ç¸½æ”¯å‡º</th><th class="text-right">æœ¬æœŸç›ˆè™§</th></tr>
                    </thead>
                    <tbody id="agg-search-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    let agg_data = [];

    // --- Tab åˆ‡æ› ---
    function switchTab(tabId) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    // --- å¡«å ±ç«¯é‚è¼¯ ---
    function mgr_createInput(cls, val='', ro=false, oninp='') {
        const tip = ro ? '' : 'data-input-tip="å¯å¾ Excel è¤‡è£½å¤šå€‹å„²å­˜æ ¼åœ¨æ­¤è²¼ä¸Š"';
        const type = (cls === 'name-input' || ro) ? 'text' : 'number';
        return `<input type="${type}" class="${cls}" value="${val}" ${ro?'readonly':''} ${oninp?'oninput="'+oninp+'(this)"':''} placeholder="${ro?'':0}" ${tip}>`;
    }

    function mgr_addOpRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer" onclick="mgr_delRow(this)">Ã—</span></td>
            <td>${mgr_createInput('name-input',d.name)}</td>
            <td>${mgr_createInput('v-rev',d.rev,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-cost',d.cost,0,'mgr_calcOp')}</td>
            <td>${mgr_createInput('v-gross',d.gross,1)}</td><td>${mgr_createInput('v-exp',d.exp,0,'mgr_calcOp')}</td>
            <td>${mgr_createInput('v-opprofit',d.opprofit,1)}</td><td>${mgr_createInput('v-nonrev',d.nonrev,0,'mgr_calcOp')}</td>
            <td>${mgr_createInput('v-nonexp',d.nonexp,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-pretax',d.pretax,1)}</td>
            <td>${mgr_createInput('v-tax',d.tax,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-net font-bold',d.net,1)}</td>`;
        document.getElementById('mgr-tbody-op').appendChild(tr);
    }

    function mgr_addWkRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer" onclick="mgr_delRow(this)">Ã—</span></td>
            <td>${mgr_createInput('name-input',d.name)}</td>
            <td>${mgr_createInput('v-rev',d.rev,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-cost',d.cost,0,'mgr_calcWk')}</td>
            <td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-nonrev',d.nonrev,0,'mgr_calcWk')}</td>
            <td>${mgr_createInput('v-nonexp',d.nonexp,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-net font-bold',d.net,1)}</td>`;
        document.getElementById('mgr-tbody-wk').appendChild(tr);
    }

    function mgr_addDebtRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer" onclick="mgr_delRow(this)">Ã—</span></td>
            <td>${mgr_createInput('name-input',d.name)}</td>
            <td>${mgr_createInput('v-source',d.source,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-use',d.use,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-begin',d.begin,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-end font-bold',d.end,1)}</td>`;
        document.getElementById('mgr-tbody-debt').appendChild(tr);
    }

    function mgr_addSpRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer" onclick="mgr_delRow(this)">Ã—</span></td>
            <td>${mgr_createInput('name-input',d.name)}</td>
            <td>${mgr_createInput('v-source',d.source,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-use',d.use,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-begin',d.begin,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-remit',d.remit,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-end font-bold',d.end,1)}</td>`;
        document.getElementById('mgr-tbody-sp').appendChild(tr);
    }

    function mgr_addCapRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer" onclick="mgr_delRow(this)">Ã—</span></td>
            <td>${mgr_createInput('name-input',d.name)}</td>
            <td>${mgr_createInput('v-source',d.source,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-use',d.use,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-begin',d.begin,0,'mgr_calcSp')}</td>
            <td>${mgr_createInput('v-end font-bold',d.end,1)}</td>`;
        document.getElementById('mgr-tbody-cap').appendChild(tr);
    }

    // è¨ˆç®—é‚è¼¯
    const mVal = (r,s) => parseFloat(r.querySelector(s)?.value)||0;
    const mSet = (r,s,v) => { if(r.querySelector(s)) r.querySelector(s).value = v; };
    function mgr_calcOp(e) { 
        const r=e.closest('tr'); const g=mVal(r,'.v-rev')-mVal(r,'.v-cost'), op=g-mVal(r,'.v-exp'), np=mVal(r,'.v-nonrev')-mVal(r,'.v-nonexp'); 
        mSet(r,'.v-gross',g); mSet(r,'.v-opprofit',op); mSet(r,'.v-pretax',op+np); mSet(r,'.v-net',op+np-mVal(r,'.v-tax')); mgr_autoSave(); 
    }
    function mgr_calcWk(e) { 
        const r=e.closest('tr'); const s=mVal(r,'.v-rev')-mVal(r,'.v-cost'), ns=mVal(r,'.v-nonrev')-mVal(r,'.v-nonexp'); 
        mSet(r,'.v-surplus',s); mSet(r,'.v-net',s+ns); mgr_autoSave(); 
    }
    function mgr_calcSp(e) { 
        const r=e.closest('tr'); const s=mVal(r,'.v-source')-mVal(r,'.v-use'); 
        mSet(r,'.v-surplus',s); mSet(r,'.v-end',mVal(r,'.v-begin')+s-mVal(r,'.v-remit')); mgr_autoSave(); 
    }

    // Excel è²¼ä¸Šé—œéµé‚è¼¯
    document.addEventListener('paste', function (e) {
        const activeElem = document.activeElement;
        if (!activeElem || activeElem.tagName !== 'INPUT' || activeElem.readOnly) return;
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('Text');
        if (pastedData.includes('\t') || pastedData.includes('\n')) {
            e.preventDefault();
            const rows = pastedData.split(/\r\n|\n|\r/);
            const currentRow = activeElem.closest('tr');
            const tbody = currentRow.parentNode;
            const startColIdx = Array.from(currentRow.children).indexOf(activeElem.closest('td'));
            const startRowIdx = Array.from(tbody.children).indexOf(currentRow);
            rows.forEach((rowStr, i) => {
                if (rowStr.trim() === "") return;
                const cols = rowStr.split('\t');
                const targetRow = tbody.children[startRowIdx + i];
                if (targetRow) {
                    cols.forEach((value, j) => {
                        const targetTd = targetRow.children[startColIdx + j];
                        if (targetTd) {
                            const input = targetTd.querySelector('input:not([readonly])');
                            if (input) {
                                input.value = value.trim().replace(/[,%$]/g, '');
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                    });
                }
            });
        }
    });

    // æ•¸æ“šæŒä¹…åŒ–
    function mgr_autoSave() { localStorage.setItem('mgr_full_v3', JSON.stringify(mgr_collectData())); }
    function mgr_loadFromStorage() { const s=localStorage.getItem('mgr_full_v3'); if(s) mgr_populate(JSON.parse(s)); }
    function mgr_collectData() {
        const scrape = (id, fields) => Array.from(document.querySelectorAll(`#${id} tr`)).map(r => {
            let o={}; fields.forEach(f=>o[f.key]=r.querySelector(f.sel)?.value); return o.name?o:null;
        }).filter(x=>x);
        return {
            metadata: { org: document.getElementById('mgr-org').value, year: document.getElementById('mgr-year').value, user: document.getElementById('mgr-user').value },
            op: scrape('mgr-tbody-op', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'exp',sel:'.v-exp'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'tax',sel:'.v-tax'},{key:'net',sel:'.v-net'}]),
            wk: scrape('mgr-tbody-wk', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'net',sel:'.v-net'}]),
            sp: scrape('mgr-tbody-sp', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'remit',sel:'.v-remit'},{key:'end',sel:'.v-end'}]),
            debt: scrape('mgr-tbody-debt', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'end',sel:'.v-end'}]),
            cap: scrape('mgr-tbody-cap', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'end',sel:'.v-end'}])
        };
    }
    function mgr_populate(d) {
        document.getElementById('mgr-org').value = d.metadata.org || '';
        document.getElementById('mgr-year').value = d.metadata.year || '114';
        document.getElementById('mgr-user').value = d.metadata.user || '';
        ['op','wk','debt','sp','cap'].forEach(t => document.getElementById(`mgr-tbody-${t}`).innerHTML = '');
        d.op?.forEach(i=>mgr_addOpRow(i)); d.wk?.forEach(i=>mgr_addWkRow(i));
        d.debt?.forEach(i=>mgr_addDebtRow(i)); d.sp?.forEach(i=>mgr_addSpRow(i)); d.cap?.forEach(i=>mgr_addCapRow(i));
    }
    function mgr_delRow(btn) { if(confirm('åˆªé™¤æ­¤åˆ—ï¼Ÿ')) { btn.closest('tr').remove(); mgr_autoSave(); } }
    function mgr_exportJSON() { const d=mgr_collectData(); saveAs(new Blob([JSON.stringify(d,null,2)],{type:"application/json"}), `${d.metadata.org}.json`); }
    function mgr_clearAll() { if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.removeItem('mgr_full_v3'); location.reload(); } }

    // --- åŒ¯æ•´å„€è¡¨æ¿é‚è¼¯ ---
    function agg_setupDrag() {
        const zone = document.getElementById('agg-dropzone');
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('active'));
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('active'); agg_handleFiles(e.dataTransfer.files); });
    }

    function agg_handleFiles(files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.metadata) agg_process(json);
                } catch(err) { console.error("æª”æ¡ˆè§£æéŒ¯èª¤", err); }
            };
            reader.readAsText(file);
        });
    }

    function agg_process(json) {
        const idx = agg_data.findIndex(g => g.metadata.org === json.metadata.org);
        if(idx >= 0) agg_data[idx] = json; else agg_data.push(json);
        agg_updateDashboard();
    }

    function agg_updateDashboard() {
        document.getElementById('agg-content').classList.remove('hidden');
        const sel = document.getElementById('agg-filter-gov');
        sel.innerHTML = '<option value="all">ğŸ¢ æ‰€æœ‰å–®ä½</option>';
        agg_data.forEach(g => sel.innerHTML += `<option value="${g.metadata.org}">${g.metadata.org}</option>`);

        let s = { govs: agg_data.length, rev: 0, surplus: 0, loss: 0 };
        agg_data.forEach(g => {
            ['op','wk','sp','debt','cap'].forEach(t => {
                g[t]?.forEach(f => {
                    let i = parseFloat(f.rev || f.source || 0);
                    let n = parseFloat(f.net || f.surplus || 0);
                    s.rev += i; s.surplus += n;
                    if(n < 0) s.loss++;
                });
            });
        });
        document.getElementById('kpi-govs').innerText = s.govs;
        document.getElementById('kpi-rev').innerText = (s.rev/100000).toFixed(2);
        document.getElementById('kpi-surplus').innerText = (s.surplus/100000).toFixed(2);
        document.getElementById('kpi-loss').innerText = s.loss;
        agg_search();
    }

    function agg_search() {
        const gov = document.getElementById('agg-filter-gov').value;
        const txt = document.getElementById('agg-search-txt').value.toLowerCase();
        const type = document.getElementById('agg-filter-type').value;
        const tbody = document.getElementById('agg-search-body');
        tbody.innerHTML = '';

        agg_data.forEach(g => {
            if(gov !== 'all' && g.metadata.org !== gov) return;
            ['op','wk','sp','debt','cap'].forEach(t => {
                if(type !== 'all' && type !== t) return;
                g[t]?.forEach(f => {
                    if(txt && !f.name.toLowerCase().includes(txt)) return;
                    let i = parseFloat(f.rev || f.source || 0);
                    let n = parseFloat(f.net || f.surplus || 0);
                    tbody.innerHTML += `<tr class="border-b border-slate-700">
                        <td>${g.metadata.org}</td><td>${t.toUpperCase()}</td><td>${f.name}</td>
                        <td class="text-right">${i.toLocaleString()}</td><td class="text-right">--</td>
                        <td class="text-right font-bold ${n>=0?'text-green-400':'text-red-400'}">${n.toLocaleString()}</td>
                    </tr>`;
                });
            });
        });
    }

    function mgr_importFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                mgr_populate(d);
                mgr_autoSave();
            } catch(err) { alert("è®€å–å¤±æ•—"); }
        };
        reader.readAsText(file);
    }

    function mgr_exportXLSX() {
        const d = mgr_collectData();
        const wb = XLSX.utils.book_new();
        const createSheet = (name, data) => {
            if(!data || data.length===0) return;
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), name);
        };
        createSheet('ç‡Ÿæ¥­åŸºé‡‘', d.op); createSheet('ä½œæ¥­åŸºé‡‘', d.wk);
        createSheet('ç‰¹åˆ¥æ”¶å…¥', d.sp); createSheet('è³‡æœ¬è¨ˆç•«', d.cap);
        XLSX.writeFile(wb, `${d.metadata.org}_é ç®—åŒ¯æ•´.xlsx`);
    }

    function agg_clearAll() { agg_data = []; document.getElementById('agg-content').classList.add('hidden'); }

    document.addEventListener('DOMContentLoaded', () => {
        mgr_loadFromStorage();
        agg_setupDrag();
    });
</script>
</body>
</html>
