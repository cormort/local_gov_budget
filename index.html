<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Hardened CSP: no unsafe-inline, no unsafe-eval -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';">
    <title>政府預算查填匯總系統 v4.0.0 (CSP 強化版)</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="budget-style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="budget-app.js" defer></script>
</head>
<body>

<nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl">🇹🇼</div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">政府預算查填匯總平臺</h1>
                <p class="text-xs text-slate-500">v4.0.0 (CSP 強化 + 自動儲存 + Undo)</p>
            </div>
        </div>
        <div class="tab-pill-container bg-slate-100 p-1 rounded-full flex gap-1">
            <button id="btn-manager" class="px-6 py-2 rounded-full font-bold transition active bg-white shadow-sm">📝 填報站</button>
            <button id="btn-aggregator" class="px-6 py-2 rounded-full font-bold transition text-slate-500">📊 匯整端</button>
        </div>
    </div>
</nav>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 block">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <h2 class="text-2xl font-bold text-slate-800">預算填報工作站</h2>
            <span class="animate-pulse bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold border border-blue-200">✨ 支援 Excel 貼上</span>
            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold border border-green-200">💾 自動儲存</span>
        </div>
        <div class="flex gap-2">
            <button id="btn-import" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold border hover:bg-slate-200">📂 匯入舊檔</button>
            <input type="file" id="mgr-import-file" class="hidden" accept=".json,.html">
            <button id="btn-export-json" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700">💾 匯出 JSON</button>
            <button id="btn-export-html" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">🌍 備份 HTML</button>
            <button id="btn-export-xlsx" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700">📊 匯出 Excel</button>
            <button id="btn-clear" class="text-red-500 px-3 py-2 border rounded-lg text-sm hover:bg-red-50">🗑️ 清空</button>
        </div>
    </div>

    <div class="excel-guide flex items-center gap-2">
        <span>💡</span>
        <span><b>操作提示：</b>您可以從 Excel 選取整塊資料區域按下 <kbd class="bg-white px-1 border rounded">Ctrl+C</kbd>，點擊下方表單任一格子按下 <kbd class="bg-white px-1 border rounded">Ctrl+V</kbd> 即可快速填入多列數據。按 <kbd class="bg-white px-1 border rounded">Tab</kbd> 跳至下一格，<kbd class="bg-white px-1 border rounded">Enter</kbd> 跳至下一列。</span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div><label class="text-xs font-bold text-slate-400 uppercase">機關名稱</label><input type="text" id="mgr-org" class="border-b-2 w-full p-2 outline-none font-bold focus:border-blue-500"></div>
        <div><label class="text-xs font-bold text-slate-400 uppercase">年度</label><input type="number" id="mgr-year" class="border-b-2 w-full p-2 outline-none" value="115"></div>
        <div><label class="text-xs font-bold text-slate-400 uppercase">填表人</label><input type="text" id="mgr-user" class="border-b-2 w-full p-2 outline-none" placeholder="姓名"></div>
    </div>
    <div id="sections-container"></div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-6 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">📊 匯整端</h2>
        <button id="btn-agg-clear" class="text-red-400 px-4 py-2 border border-red-400 rounded-lg text-sm hover:bg-red-900/30">🗑️ 清除全部</button>
    </div>
    <div id="agg-dropzone" class="drop-zone p-12 text-center cursor-pointer mb-8 rounded-xl">📥 拖曳 JSON 或 HTML 至此匯整</div>
    <div id="agg-content" class="hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="agg-kpi"></div>
        <div id="agg-list-area" class="bg-slate-800 p-6 rounded-xl border border-slate-700"><table class="w-full text-left text-sm"><tbody id="agg-list-body"></tbody></table></div>
    </div>
</div>

<!-- Autosave indicator -->
<div id="autosave-indicator" class="autosave-indicator">✓ 已自動儲存</div>

<!-- Undo button (no inline onclick) -->
<button id="undo-btn" class="undo-btn">↩ 復原 (Ctrl+Z)</button>

</body>
</html>
