<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—æŸ¥å¡«ç³»çµ± v3.4 (çµ±ä¸€æ ¼å¼ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .budget-table th { background-color: #e2e8f0; padding: 10px 8px; font-size: 0.85rem; border: 1px solid #cbd5e1; white-space: nowrap; color: #475569; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 110px; }
        .budget-table input { width: 100%; padding: 6px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.95rem; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; border-radius: 4px; }
        .budget-table input[readonly] { font-weight: 700; cursor: default; background-color: #f8fafc; }
        .negative-value { color: #ef4444 !important; font-weight: 700; }
        .total-row { background-color: #f8fafc; font-weight: 800; }
        .section-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 2rem; border-top: 4px solid #64748b; }
        [data-input-tip]:hover::after {
            content: attr(data-input-tip); position: absolute; bottom: 100%; left: 0;
            background: #334155; color: white; padding: 3px 8px; border-radius: 4px;
            font-size: 0.7rem; white-space: nowrap; z-index: 100; pointer-events: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-[98%] mx-auto">
    <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <div>
            <h1 class="text-3xl font-extrabold text-slate-800">æ”¿åºœé ç®—æŸ¥å¡«å¹³è‡º <span class="text-sm font-normal text-slate-400">v3.4</span></h1>
            <p class="text-slate-500 mt-1">çµ±ä¸€éç‡Ÿæ¥­åŸºé‡‘æ¬„ä½æ ¼å¼ï¼Œæ”¯æ´ç´…å­—ç›ˆè™§åŠåˆè¨ˆ</p>
        </div>
        <div class="flex gap-3">
            <button onclick="mgr_exportXLSX()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-bold transition shadow-lg flex items-center gap-2">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_exportHTML()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-2.5 rounded-lg font-bold transition">ğŸŒ å­˜æª”å‚™ä»½</button>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8 grid grid-cols-1 md:grid-cols-3 gap-8">
        <div><label class="block text-xs font-bold text-slate-400 mb-1">å–®ä½åç¨±</label><input type="text" id="mgr-org" class="w-full border-b-2 border-slate-200 py-2 text-xl font-bold outline-none focus:border-blue-500" placeholder="è«‹è¼¸å…¥å¡«å ±æ©Ÿé—œ"></div>
        <div><label class="block text-xs font-bold text-slate-400 mb-1">é ç®—å¹´åº¦</label><input type="number" id="mgr-year" value="115" class="w-full border-b-2 border-slate-200 py-2 text-xl font-bold outline-none focus:border-blue-500"></div>
        <div><label class="block text-xs font-bold text-slate-400 mb-1">æ‰¿è¾¦äººå“¡</label><input type="text" id="mgr-user" class="w-full border-b-2 border-slate-200 py-2 text-xl font-bold outline-none focus:border-blue-500" placeholder="å§“å"></div>
    </div>

    <div id="sections-container"></div>
</div>

<script>
    // å®šç¾©æ‰€æœ‰é¡åˆ¥èˆ‡å°æ‡‰æ¬„ä½
    // ç‡Ÿæ¥­ (OP) èˆ‡ ä½œæ¥­ (WK) ç¶­æŒå°ˆæœ‰æ ¼å¼
    // ç‰¹åˆ¥æ”¶å…¥ (SP)ã€å‚µå‹™ (DB)ã€è³‡æœ¬è¨ˆç•« (CP) çµ±ä¸€æ ¼å¼
    const sectionConfigs = [
        { id: 'op', title: 'ä¸€ã€ç‡Ÿæ¥­åŸºé‡‘', color: '#2563eb', fields: ['name','rev','cost','gross','exp','opprofit','pretax','net'] },
        { id: 'wk', title: 'äºŒã€ä½œæ¥­åŸºé‡‘', color: '#16a34a', fields: ['name','rev','cost','surplus','non','net'] },
        { id: 'sp', title: 'ä¸‰ã€ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘', color: '#9333ea', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'db', title: 'å››ã€å‚µå‹™åŸºé‡‘', color: '#ea580c', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'cp', title: 'äº”ã€è³‡æœ¬è¨ˆç•«åŸºé‡‘', color: '#0891b2', fields: ['name','source','use','surplus','begin','remit','end'] }
    ];

    const fieldNames = {
        name:'åŸºé‡‘åç¨±', rev:'ç‡Ÿæ¥­/æ¥­å‹™æ”¶å…¥', cost:'æˆæœ¬è²»ç”¨', gross:'ç‡Ÿæ¥­æ¯›åˆ©', exp:'ç‡Ÿæ¥­è²»ç”¨', 
        opprofit:'ç‡Ÿæ¥­åˆ©ç›Š', pretax:'ç¨…å‰æ·¨åˆ©', net:'æœ¬æœŸç›ˆè™§', surplus:'æœ¬æœŸè³¸é¤˜', non:'æ¥­å¤–æ”¶æ”¯',
        source:'åŸºé‡‘ä¾†æº', use:'åŸºé‡‘ç”¨é€”', begin:'æœŸåˆç´¯ç©', remit:'è§£ç¹³å…¬åº«', end:'æœŸæœ«ç´¯ç©'
    };

    // æ¸²æŸ“ HTML çµæ§‹
    function renderStructure() {
        const container = document.getElementById('sections-container');
        sectionConfigs.forEach(conf => {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.style.borderTopColor = conf.color;
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" style="color: ${conf.color}">${conf.title}</h2>
                    <button onclick="mgr_addRow('${conf.id}')" class="bg-slate-100 text-slate-600 px-4 py-1.5 rounded-full text-sm font-bold hover:bg-slate-200">+ æ–°å¢</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full budget-table">
                        <thead><tr><th class="w-10"></th>${conf.fields.map(f => `<th>${fieldNames[f]}</th>`).join('')}</tr></thead>
                        <tbody id="tbody-${conf.id}"></tbody>
                        <tfoot id="tfoot-${conf.id}" class="total-row"></tfoot>
                    </table>
                </div>`;
            container.appendChild(card);
            
            // åˆå§‹åŒ– Footer
            let footHtml = `<tr><td class="text-center">âˆ‘</td><td class="text-center font-bold">å°è¨ˆ</td>`;
            conf.fields.slice(1).forEach(f => footHtml += `<td><input type="text" class="t-${f}" readonly value="0"></td>`);
            document.getElementById(`tfoot-${conf.id}`).innerHTML = footHtml + `</tr>`;
            
            mgr_addRow(conf.id);
        });
    }

    // æ–°å¢åˆ—
    function mgr_addRow(type) {
        const conf = sectionConfigs.find(c => c.id === type);
        const tr = document.createElement('tr');
        let html = `<td class="text-center"><button onclick="this.closest('tr').remove(); update('${type}');" class="text-red-400 hover:text-red-600">âœ•</button></td>`;
        conf.fields.forEach(f => {
            const isName = f === 'name';
            const isRO = ['gross','opprofit','pretax','net','surplus','end'].includes(f);
            html += `<td><input type="${isName?'text':'number'}" class="v-${f} ${isName?'name-input':''}" ${isRO?'readonly':''} oninput="update('${type}')" data-input-tip="æ”¯æ´ Excel è²¼ä¸Š"></td>`;
        });
        tr.innerHTML = html;
        document.getElementById(`tbody-${type}`).appendChild(tr);
    }

    // è¨ˆç®—èˆ‡æ›´æ–°
    function update(type) {
        const rows = document.querySelectorAll(`#tbody-${type} tr`);
        const conf = sectionConfigs.find(c => c.id === type);
        const totals = {};
        conf.fields.slice(1).forEach(f => totals[f] = 0);

        rows.forEach(row => {
            const v = (cls) => parseFloat(row.querySelector('.v-'+cls).value) || 0;
            const r = (cls) => row.querySelector(cls);

            // åŸ·è¡Œè¨ˆç®—è¦å‰‡
            if(type === 'op') {
                const g = v('rev') - v('cost'); r('.v-gross').value = g;
                const p = g - v('exp'); r('.v-opprofit').value = p;
                r('.v-pretax').value = p; r('.v-net').value = p;
            } else if(type === 'wk') {
                const s = v('rev') - v('cost'); r('.v-surplus').value = s;
                r('.v-net').value = s + v('non');
            } else {
                // SP, DB, CP çµ±ä¸€è¨ˆç®—è¦å‰‡
                const s = v('source') - v('use'); r('.v-surplus').value = s;
                r('.v-end').value = v('begin') + s - v('remit');
            }

            // ç´…å­—æ¨™ç¤ºèˆ‡åŠ ç¸½
            conf.fields.slice(1).forEach(f => {
                const el = row.querySelector('.v-'+f);
                const val = parseFloat(el.value) || 0;
                el.classList.toggle('negative-value', val < 0);
                totals[f] += val;
            });
        });

        // æ›´æ–° Footer åˆè¨ˆ
        Object.keys(totals).forEach(f => {
            const tEl = document.querySelector(`#tfoot-${type} .t-${f}`);
            tEl.value = totals[f].toLocaleString();
            tEl.classList.toggle('negative-value', totals[f] < 0);
        });
    }

    // Excel è²¼ä¸ŠåŠŸèƒ½
    document.addEventListener('paste', e => {
        const el = document.activeElement;
        if (!el || el.tagName !== 'INPUT' || el.readOnly) return;
        const text = e.clipboardData.getData('text');
        if (!text.includes('\t')) return;
        e.preventDefault();
        const rowsData = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        const startTr = el.closest('tr');
        const tbody = startTr.parentNode;
        const type = tbody.id.replace('tbody-', '');
        const startColIdx = Array.from(startTr.children).indexOf(el.closest('td'));
        const startRowIdx = Array.from(tbody.children).indexOf(startTr);

        rowsData.forEach((rowStr, i) => {
            let targetTr = tbody.children[startRowIdx + i];
            if (!targetTr) { mgr_addRow(type); targetTr = tbody.lastElementChild; }
            rowStr.split('\t').forEach((val, j) => {
                const input = targetTr.children[startColIdx + j]?.querySelector('input:not([readonly])');
                if (input) { 
                    input.value = val.trim().replace(/,/g, ''); 
                    input.dispatchEvent(new Event('input')); 
                }
            });
        });
    });

    // åŒ¯å‡ºåŠŸèƒ½
    function mgr_exportXLSX() {
        const wb = XLSX.utils.book_new();
        sectionConfigs.forEach(conf => {
            const rows = Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`));
            if(rows.length === 0) return;
            const data = rows.map(tr => {
                let obj = {};
                conf.fields.forEach(f => obj[fieldNames[f]] = tr.querySelector('.v-'+f).value);
                return obj;
            });
            // åˆè¨ˆè¡Œ
            let totalRow = { [fieldNames['name']]: "â˜… åˆè¨ˆ" };
            conf.fields.slice(1).forEach(f => {
                totalRow[fieldNames[f]] = data.reduce((sum, r) => sum + (parseFloat(r[fieldNames[f]])||0), 0);
            });
            data.push(totalRow);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), conf.title.split('ã€')[1]);
        });
        XLSX.writeFile(wb, "æ”¿åºœé ç®—å®Œæ•´å ±è¡¨.xlsx");
    }

    function mgr_exportHTML() {
        document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
        saveAs(new Blob(["<!DOCTYPE html>\n" + document.documentElement.outerHTML], {type: "text/html"}), "é ç®—è³‡æ–™å‚™ä»½.html");
    }

    renderStructure();
</script>
</body>
</html>
