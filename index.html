<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—æŸ¥å¡«èˆ‡åŒ¯ç¸½ç³»çµ± v3.8 (JSON & HTML é›™æ”¯æ´)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .budget-table th { background-color: #e2e8f0; padding: 10px 8px; font-size: 0.8rem; border: 1px solid #cbd5e1; white-space: nowrap; color: #334155; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 100px; }
        .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
        .budget-table input[readonly] { font-weight: bold; background-color: #f8fafc; }
        .negative-value { color: #dc2626 !important; font-weight: bold; }
        .total-row { background-color: #f1f5f9; font-weight: bold; }
        .section-card { background: white; padding: 24px; border-radius: 12px; margin-bottom: 2rem; border-top: 4px solid #64748b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .drop-zone { border: 3px dashed #475569; transition: 0.3s; background-color: #1e293b; border-radius: 12px; }
        .drop-zone.active { border-color: #38bdf8; background-color: #334155; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; color: white; }
    </style>
</head>
<body>

<nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold">ğŸ‡¹ğŸ‡¼</div>
            <h1 class="font-bold text-lg text-slate-800">æ”¿åºœé ç®—æŸ¥å¡«åŒ¯ç¸½ç³»çµ± v3.8</h1>
        </div>
        <div class="bg-slate-100 p-1 rounded-full flex gap-1">
            <button onclick="switchTab('manager')" id="btn-manager" class="px-6 py-2 rounded-full font-bold transition active bg-white shadow-sm">ğŸ“ å¡«å ±ç«™</button>
            <button onclick="switchTab('aggregator')" id="btn-aggregator" class="px-6 py-2 rounded-full font-bold transition text-slate-500">ğŸ“Š åŒ¯æ•´ç«¯</button>
        </div>
    </div>
</nav>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 block">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800">é ç®—å¡«å ±å·¥ä½œç«™</h2>
        <div class="flex gap-2">
            <button onclick="mgr_exportJSON()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700">ğŸ’¾ åŒ¯å‡º JSON</button>
            <button onclick="mgr_exportHTML()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-teal-700">ğŸŒ å‚™ä»½ HTML</button>
            <button onclick="mgr_exportXLSX()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_clearAll()" class="text-red-500 px-3 py-2 border rounded-lg text-sm hover:bg-red-50">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <input type="text" id="mgr-org" class="border-b-2 w-full p-2 outline-none font-bold" placeholder="å¡«å ±æ©Ÿé—œåç¨±">
        <input type="number" id="mgr-year" class="border-b-2 w-full p-2 outline-none" value="115">
        <input type="text" id="mgr-user" class="border-b-2 w-full p-2 outline-none" placeholder="æ‰¿è¾¦äººå§“å">
    </div>
    <div id="sections-container"></div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-6 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-6">
        <h1 class="text-3xl font-bold">ğŸ“Š åŒ¯æ•´å„€è¡¨æ¿</h1>
        <button onclick="agg_clearAll()" class="bg-red-900/40 text-red-200 px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ æ¸…ç©ºæ•¸æ“š</button>
    </div>
    <div id="agg-dropzone" class="drop-zone p-12 text-center cursor-pointer mb-8">
        <p class="text-xl font-bold text-slate-300">ğŸ“¥ æ‹–æ›³å–®ä½çš„ JSON æˆ– HTML å‚™ä»½æª”è‡³æ­¤é€²è¡Œè‡ªå‹•åŒ¯æ•´</p>
        <p class="text-slate-500 text-sm mt-2">ç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥æ ¼å¼ä¸¦æå–é ç®—æ•¸å€¼</p>
    </div>
    <div id="agg-content" class="hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="agg-kpi"></div>
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead><tr class="border-b border-slate-600"><th class="pb-3">æ©Ÿé—œ</th><th class="pb-3">åŸºé‡‘é¡å‹</th><th class="pb-3">åŸºé‡‘åç¨±</th><th class="pb-3 text-right">é ç®—ç›ˆè™§</th></tr></thead>
                    <tbody id="agg-list-body" class="text-slate-300"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- é…ç½®èˆ‡ç§‘ç›®å®šç¾© ---
    const sectionConfigs = [
        { id: 'op', title: 'ä¸€ã€ç‡Ÿæ¥­åŸºé‡‘', color: '#2563eb', fields: ['name','rev','cost','gross','exp','opprofit','nonrev','nonexp','nonprofit','pretax','tax','net'] },
        { id: 'wk', title: 'äºŒã€ä½œæ¥­åŸºé‡‘', color: '#16a34a', fields: ['name','rev','cost','surplus','nonrev','nonexp','nonsurplus','net'] },
        { id: 'db', title: 'ä¸‰ã€å‚µå‹™åŸºé‡‘', color: '#ea580c', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'sp', title: 'å››ã€ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘', color: '#9333ea', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'cp', title: 'äº”ã€è³‡æœ¬è¨ˆç•«åŸºé‡‘', color: '#0891b2', fields: ['name','source','use','surplus','begin','remit','end'] }
    ];

    const fieldNames = {
        name:'åŸºé‡‘åç¨±', rev:'ç‡Ÿæ¥­/æ¥­å‹™æ”¶å…¥', cost:'ç‡Ÿæ¥­/æ¥­å‹™æˆæœ¬èˆ‡è²»ç”¨', gross:'ç‡Ÿæ¥­æ¯›åˆ©(æ¯›æ)', exp:'ç‡Ÿæ¥­è²»ç”¨', 
        opprofit:'ç‡Ÿæ¥­åˆ©ç›Š(æå¤±)', nonrev:'ç‡Ÿæ¥­/æ¥­å‹™å¤–æ”¶å…¥', nonexp:'ç‡Ÿæ¥­/æ¥­å‹™å¤–è²»ç”¨', nonprofit:'ç‡Ÿæ¥­å¤–åˆ©ç›Š(æå¤±)', 
        pretax:'ç¨…å‰æ·¨åˆ©(æ·¨æ)', tax:'æ‰€å¾—ç¨…è²»ç”¨(åˆ©ç›Š)', net:'æœ¬æœŸæ·¨åˆ©/è³¸é¤˜(æ·¨æ/çŸ­çµ€)', surplus:'æœ¬æœŸè³¸é¤˜(çŸ­çµ€)', 
        nonsurplus:'æ¥­å‹™å¤–è³¸é¤˜(çŸ­çµ€)', source:'åŸºé‡‘ä¾†æº', use:'åŸºé‡‘ç”¨é€”', begin:'æœŸåˆåŸºé‡‘é¤˜é¡', remit:'è§£ç¹³å…¬åº«', end:'æœŸæœ«åŸºé‡‘é¤˜é¡'
    };

    function switchTab(id) {
        document.getElementById('tab-manager').classList.toggle('hidden', id !== 'manager');
        document.getElementById('tab-aggregator').classList.toggle('hidden', id !== 'aggregator');
        document.getElementById('btn-manager').className = `px-6 py-2 rounded-full font-bold transition ${id === 'manager' ? 'bg-white shadow-sm' : 'text-slate-500'}`;
        document.getElementById('btn-aggregator').className = `px-6 py-2 rounded-full font-bold transition ${id === 'aggregator' ? 'bg-white shadow-sm' : 'text-slate-500'}`;
    }

    function render() {
        const container = document.getElementById('sections-container');
        sectionConfigs.forEach(conf => {
            const div = document.createElement('div');
            div.className = 'section-card'; div.style.borderTopColor = conf.color;
            div.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg" style="color:${conf.color}">${conf.title}</h3><button onclick="mgr_addRow('${conf.id}')" class="text-blue-600 text-xs font-bold hover:underline">+ æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th>${conf.fields.map(f => `<th>${fieldNames[f]}</th>`).join('')}</tr></thead><tbody id="tbody-${conf.id}"></tbody><tfoot id="tfoot-${conf.id}" class="total-row"><tr><td>âˆ‘</td><td class="text-center">åˆè¨ˆ</td>${conf.fields.slice(1).map(f => `<td><input type="text" class="t-${f}" readonly value="0"></td>`).join('')}</tr></tfoot></table></div>`;
            container.appendChild(div);
            mgr_addRow(conf.id);
        });
    }

    function mgr_addRow(type) {
        const conf = sectionConfigs.find(c => c.id === type);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="text-center"><button onclick="this.closest('tr').remove(); update('${type}');">âœ•</button></td>` + 
            conf.fields.map(f => {
                const isRO = ['gross','opprofit','nonprofit','pretax','net','surplus','nonsurplus','end'].includes(f);
                return `<td><input type="${f==='name'?'text':'number'}" class="v-${f} ${f==='name'?'text-left':''}" ${isRO?'readonly':''} oninput="update('${type}')"></td>`;
            }).join('');
        document.getElementById(`tbody-${type}`).appendChild(tr);
    }

    function update(type) {
        const rows = document.querySelectorAll(`#tbody-${type} tr`);
        const conf = sectionConfigs.find(c => c.id === type);
        let totals = {}; conf.fields.slice(1).forEach(f => totals[f] = 0);
        rows.forEach(row => {
            const v = (c) => parseFloat(row.querySelector('.v-'+c).value) || 0;
            const r = (c) => row.querySelector('.v-'+c);
            if(type === 'op') { let g=v('rev')-v('cost'), op=g-v('exp'), np=v('nonrev')-v('nonexp'); r('gross').value=g; r('opprofit').value=op; r('nonprofit').value=np; r('pretax').value=op+np; r('net').value=op+np-v('tax'); }
            else if(type === 'wk') { let s=v('rev')-v('cost'), ns=v('nonrev')-v('nonexp'); r('surplus').value=s; r('nonsurplus').value=ns; r('net').value=s+ns; }
            else { let s=v('source')-v('use'); r('surplus').value=s; r('end').value=v('begin')+s-v('remit'); }
            conf.fields.slice(1).forEach(f => { let val=v(f); row.querySelector('.v-'+f).classList.toggle('negative-value', val<0); totals[f]+=val; });
        });
        Object.keys(totals).forEach(f => {
            const tEl = document.querySelector(`#tfoot-${type} .t-${f}`);
            tEl.value = totals[f].toLocaleString(); tEl.classList.toggle('negative-value', totals[f]<0);
        });
    }

    // --- æ•¸æ“šåŒ¯å‡ºèˆ‡åŒ¯æ•´æ ¸å¿ƒ ---
    function mgr_exportJSON() {
        const data = {
            metadata: { org: document.getElementById('mgr-org').value, year: document.getElementById('mgr-year').value },
            sections: sectionConfigs.map(conf => ({
                id: conf.id,
                items: Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`)).map(tr => {
                    let item = {}; conf.fields.forEach(f => item[f] = tr.querySelector('.v-'+f).value);
                    return item;
                })
            }))
        };
        saveAs(new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}), `${data.metadata.org}_é ç®—è³‡æ–™.json`);
    }

    let agg_data = [];
    function agg_setupDrag() {
        const zone = document.getElementById('agg-dropzone');
        zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('active'); };
        zone.ondragleave = () => zone.classList.remove('active');
        zone.ondrop = (e) => { e.preventDefault(); zone.classList.remove('active'); agg_handleFiles(e.dataTransfer.files); };
    }

    function agg_handleFiles(files) {
        Array.from(files).forEach(file => {
            const r = new FileReader();
            r.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.json')) {
                    agg_process(JSON.parse(content));
                } else {
                    const doc = new DOMParser().parseFromString(content, 'text/html');
                    const meta = { org: doc.getElementById('mgr-org')?.value || 'æœªçŸ¥æ©Ÿé—œ' };
                    const sections = sectionConfigs.map(conf => ({
                        id: conf.id,
                        items: Array.from(doc.querySelectorAll(`#tbody-${conf.id} tr`)).map(tr => {
                            let item = {}; conf.fields.forEach(f => {
                                const inp = tr.querySelector('.v-'+f);
                                item[f] = inp?.getAttribute('value') || inp?.value || 0;
                            });
                            return item;
                        }).filter(i => i.name)
                    }));
                    agg_process({ metadata: meta, sections: sections });
                }
            };
            r.readAsText(file);
        });
    }

    function agg_process(json) {
        const idx = agg_data.findIndex(g => g.metadata.org === json.metadata.org);
        if(idx >= 0) agg_data[idx] = json; else agg_data.push(json);
        agg_updateUI();
    }

    function agg_updateUI() {
        document.getElementById('agg-content').classList.remove('hidden');
        let rev = 0, surplus = 0, loss = 0;
        const tbody = document.getElementById('agg-list-body');
        tbody.innerHTML = '';

        agg_data.forEach(g => {
            g.sections.forEach(s => s.items.forEach(i => {
                let r = parseFloat(i.rev || i.source || 0), n = parseFloat(i.net || i.surplus || 0);
                rev += r; surplus += n; if(n < 0) loss++;
                tbody.innerHTML += `<tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                    <td class="py-3 font-bold">${g.metadata.org}</td><td>${s.id.toUpperCase()}</td><td>${i.name}</td>
                    <td class="text-right font-bold ${n<0?'text-red-400':'text-green-400'}">${n.toLocaleString()}</td></tr>`;
            }));
        });
        document.getElementById('agg-kpi').innerHTML = `<div class="stat-card">æ©Ÿé—œï¼š${agg_data.length}</div><div class="stat-card">é ç®—ç¸½æ”¶ï¼š${(rev/100000).toFixed(2)} å„„</div><div class="stat-card">ç¸½ç›ˆè™§ï¼š${(surplus/100000).toFixed(2)} å„„</div><div class="stat-card text-red-400">è™§æå®¶æ•¸ï¼š${loss}</div>`;
    }

    function mgr_exportHTML() {
        document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
        saveAs(new Blob(["<!DOCTYPE html>\n" + document.documentElement.outerHTML], {type: "text/html"}), "é ç®—å‚™ä»½.html");
    }

    function mgr_exportXLSX() {
        const combined = [["æ”¿åºœé ç®—åŒ¯ç¸½è¡¨"], ["æ©Ÿé—œï¼š", document.getElementById('mgr-org').value], []];
        sectionConfigs.forEach(conf => {
            combined.push([conf.title], conf.fields.map(f => fieldNames[f]));
            Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`)).forEach(tr => combined.push(conf.fields.map(f => tr.querySelector('.v-'+f).value)));
            let foot = ["åˆè¨ˆ"]; conf.fields.slice(1).forEach(f => foot.push(document.querySelector(`#tfoot-${conf.id} .t-${f}`).value));
            combined.push(foot, []);
        });
        XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet(combined), "é ç®—å ±è¡¨");
        XLSX.writeFile(XLSX.utils.book_new(), "å®Œæ•´å ±è¡¨.xlsx");
    }

    function mgr_clearAll() { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) location.reload(); }
    function agg_clearAll() { agg_data = []; document.getElementById('agg-content').classList.add('hidden'); }

    document.addEventListener('DOMContentLoaded', () => { render(); agg_setupDrag(); });
</script>
</body>
</html>
