<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—ç®¡ç†èˆ‡åŒ¯æ•´ç³»çµ±å…¥å£ç¶²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .tab-btn { padding: 12px 24px; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; transition: all 0.2s; cursor: pointer; }
        .tab-btn:hover { color: #334155; background-color: #f1f5f9; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; background-color: white; }
        .content-pane { display: none; flex: 1; height: 100%; background: white; }
        .content-pane.active { display: block; }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* é‡å°èªªæ˜é çš„æ¨£å¼ */
        .guide-container { max-width: 900px; margin: 40px auto; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); overflow-y: auto; height: calc(100% - 80px); }
        .role-card { transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .role-card:hover { transform: translateY(-5px); border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>

    <div class="bg-white border-b border-gray-200 shadow-sm z-10">
        <div class="max-w-screen-2xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ›ï¸</span>
                    <span class="font-bold text-gray-800 text-lg tracking-wide">é ç®—ç®¡ç†èˆ‡å¤§æ•¸æ“šåŒ¯æ•´ä¸­å¿ƒ</span>
                </div>
                <div class="flex space-x-1 h-full items-end">
                    <button class="tab-btn active" onclick="switchTab('guide')">ğŸ“– ä½¿ç”¨èªªæ˜</button>
                    <button class="tab-btn" onclick="switchTab('individual')">ğŸ“ é ç®—å¡«å ±ç«™ (å€‹åˆ¥æ©Ÿé—œ)</button>
                    <button class="tab-btn" onclick="switchTab('dashboard')">ğŸ“Š ç¸½é¡å„€è¡¨æ¿ (åŒ¯æ•´ä¸­å¿ƒ)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-guide" class="content-pane active bg-slate-50 overflow-y-auto">
        <div class="guide-container">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">ç³»çµ±ä½¿ç”¨åˆ†æµæŒ‡å¼•</h1>
            <p class="text-gray-600 text-center mb-10 text-lg">è«‹ä¾æ“šæ‚¨çš„èº«ä»½èˆ‡æ¥­å‹™éœ€æ±‚ï¼Œé¸æ“‡ä¸Šæ–¹å°æ‡‰çš„åˆ†é æ¨™ç±¤ã€‚</p>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="role-card p-6 rounded-xl bg-blue-50/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-2xl">ğŸ“</div>
                        <h2 class="text-xl font-bold text-blue-900">å€‹åˆ¥å¡«å ±å–®ä½</h2>
                    </div>
                    <ul class="space-y-3 text-gray-700 mb-6">
                        <li class="flex items-start gap-2"><span class="text-blue-500 font-bold">å°è±¡ï¼š</span><span>å„ç›´è½„å¸‚ã€ç¸£ï¼ˆå¸‚ï¼‰æ”¿åºœã€é„‰é®å¸‚å…¬æ‰€ã€å€‹åˆ¥å±€è™•ã€‚</span></li>
                        <li class="flex items-start gap-2"><span class="text-blue-500 font-bold">ä»»å‹™ï¼š</span><span>è¼¸å…¥å¹´åº¦é ç®—è³‡æ–™ã€è¨ˆç®—å„åŸºé‡‘ç›ˆè™§ã€ä¿å­˜å·¥ä½œé€²åº¦ã€‚</span></li>
                        <li class="flex items-start gap-2"><span class="text-blue-500 font-bold">è¼¸å‡ºï¼š</span><span>ç”¢å‡º JSON æˆ– HTML æ ¼å¼çš„é ç®—é›»å­æª”ã€‚</span></li>
                    </ul>
                    <button onclick="switchTab('individual')" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow transition">
                        å‰å¾€ã€Œé ç®—å¡«å ±ç«™ã€
                    </button>
                </div>

                <div class="role-card p-6 rounded-xl bg-indigo-50/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-2xl">ğŸ“Š</div>
                        <h2 class="text-xl font-bold text-indigo-900">åŒ¯æ•´ç®¡ç†ä¸­å¿ƒ</h2>
                    </div>
                    <ul class="space-y-3 text-gray-700 mb-6">
                        <li class="flex items-start gap-2"><span class="text-indigo-500 font-bold">å°è±¡ï¼š</span><span>ä¸»è¨ˆè™•ã€è²¡æ”¿å±€ã€ä¸­å¤®ä¸»ç®¡æ©Ÿé—œç­‰è² è²¬å½™æ•´ä¹‹å–®ä½ã€‚</span></li>
                        <li class="flex items-start gap-2"><span class="text-indigo-500 font-bold">ä»»å‹™ï¼š</span><span>åŒ¯å…¥å¤šå€‹å–®ä½çš„é ç®—æª”æ¡ˆï¼Œé€²è¡Œå…¨å£å¾‘ç¸½é¡åˆ†æèˆ‡æ¯”è¼ƒã€‚</span></li>
                        <li class="flex items-start gap-2"><span class="text-indigo-500 font-bold">è¼¸å‡ºï¼š</span><span>ç”¢å‡ºç¸½è¡¨ Excel æˆ– è¦–è¦ºåŒ–åˆ†æå ±å‘Šã€‚</span></li>
                    </ul>
                    <button onclick="switchTab('dashboard')" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow transition">
                        å‰å¾€ã€Œç¸½é¡å„€è¡¨æ¿ã€
                    </button>
                </div>
            </div>

            <div class="mt-10 p-4 border border-yellow-200 bg-yellow-50 rounded-lg text-sm text-yellow-800 flex gap-3">
                <span class="text-xl">ğŸ’¡</span>
                <div>
                    <strong class="block mb-1">æ“ä½œæç¤ºï¼š</strong>
                    æœ¬ç³»çµ±æ‰€æœ‰è³‡æ–™çš†æ–¼ç€è¦½å™¨ç«¯é‹ä½œï¼ˆLocal Processingï¼‰ï¼Œè³‡æ–™ä¸æœƒä¸Šå‚³è‡³ä»»ä½•é›²ç«¯ä¼ºæœå™¨ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚è«‹å‹™å¿…åœ¨é—œé–‰è¦–çª—å‰é»æ“Šã€ŒåŒ¯å‡ºå‚™ä»½ã€ä»¥ä¿å­˜æ‚¨çš„è³‡æ–™ã€‚
                </div>
            </div>
        </div>
    </div>

    <div id="tab-individual" class="content-pane">
        <iframe id="frame-individual"></iframe>
    </div>

    <div id="tab-dashboard" class="content-pane">
        <iframe id="frame-dashboard"></iframe>
    </div>

    <script>
        let loaded = { individual: false, dashboard: false };

        function switchTab(tabId) {
            // UI åˆ‡æ›
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content-pane').forEach(pane => pane.classList.remove('active'));
            
            // æ‰¾å‡ºç•¶å‰æŒ‰éˆ•ä¸¦å•Ÿç”¨
            const btns = document.querySelectorAll('.tab-btn');
            if(tabId === 'guide') btns[0].classList.add('active');
            if(tabId === 'individual') btns[1].classList.add('active');
            if(tabId === 'dashboard') btns[2].classList.add('active');

            document.getElementById(`tab-${tabId}`).classList.add('active');

            // æ‡¶åŠ è¼‰ (Lazy Load)ï¼šç¬¬ä¸€æ¬¡é»æ“Šæ™‚æ‰å¯«å…¥ iframe å…§å®¹ï¼Œæå‡åˆå§‹æ•ˆèƒ½ä¸¦é¿å…èƒŒæ™¯åŸ·è¡Œ
            if (tabId === 'individual' && !loaded.individual) {
                loadIframe('frame-individual', 'template-individual');
                loaded.individual = true;
            }
            if (tabId === 'dashboard' && !loaded.dashboard) {
                loadIframe('frame-dashboard', 'template-dashboard');
                loaded.dashboard = true;
            }
        }

        function loadIframe(iframeId, templateId) {
            const iframe = document.getElementById(iframeId);
            const content = document.getElementById(templateId).innerHTML;
            // è™•ç† HTML Entity è§£ç¢¼ (å¦‚æœéœ€è¦) ä¸¦å¯«å…¥
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write(content.replace(/&lt;/g, '<').replace(/&gt;/g, '>')); 
            doc.close();
        }
    </script>

    <script id="template-individual" type="text/template">
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>114å¹´åº¦åŸºé‡‘é ç®—ç®¡ç†ç³»çµ±</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
                body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
                .budget-table th { background-color: #e5e7eb; padding: 8px; font-size: 0.85rem; border: 1px solid #d1d5db; white-space: nowrap; }
                .budget-table td { padding: 4px; border: 1px solid #d1d5db; min-width: 100px; }
                .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
                .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
                .budget-table input[readonly] { font-weight: bold; color: #2563eb; background-color: #f9fafb; }
                .budget-table input.name-input { text-align: left; min-width: 180px; }
                .del-btn { color: #ef4444; cursor: pointer; padding: 0 8px; font-weight: bold; }
                .del-btn:hover { background-color: #fee2e2; border-radius: 4px; }
                @media print {
                    @page { size: landscape; margin: 10mm; }
                    body { background: white; -webkit-print-color-adjust: exact; }
                    .no-print { display: none !important; }
                    .section-card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
                    .budget-table th { background-color: #f3f4f6 !important; color: black; border: 1px solid black; }
                    .budget-table td { border: 1px solid black; }
                    input { border: none !important; background: transparent !important; }
                    #report-title { display: block !important; margin-bottom: 20px; text-align: center; font-size: 24px; font-weight: bold; }
                }
            </style>
        </head>
        <body class="p-4 md:p-8 pt-12">
        <div id="backup-alert" class="no-print fixed top-0 left-0 w-full bg-yellow-100 border-b border-yellow-300 text-yellow-800 px-4 py-2 text-center text-sm font-bold z-50 flex justify-between items-center">
            <span>âš ï¸ æé†’ï¼šè«‹å®šæœŸé»æ“Šã€ŒåŒ¯å‡ºå‚™ä»½ (HTML)ã€ä»¥ä¿å­˜å·¥ä½œé€²åº¦ï¼</span>
            <button onclick="document.getElementById('backup-alert').style.display='none'" class="text-yellow-600 hover:text-yellow-900">âœ•</button>
        </div>
        <div class="max-w-[95%] mx-auto mb-6 flex flex-wrap justify-between items-center gap-4 no-print bg-white p-4 rounded-xl shadow-md sticky top-12 z-40">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">ğŸ›ï¸ é ç®—ç®¡ç†å·¥ä½œç«™</h1>
                <span id="save-status" class="text-sm text-gray-500 flex items-center"><span class="w-2 h-2 rounded-full bg-gray-300 mr-2"></span>å°±ç·’</span>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="document.getElementById('importFile').click()" class="btn-gray border border-gray-300">ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ (JSON/HTML)</button>
                <input type="file" id="importFile" class="hidden" accept=".json,.html,.htm" onchange="importFile(this)">
                <div class="border-l pl-2 flex gap-2">
                    <button onclick="exportJSON()" class="btn-blue bg-blue-600 hover:bg-blue-700 text-white">ğŸ’¾ åŒ¯å‡º JSON</button>
                    <button onclick="exportHTML()" class="btn-blue bg-teal-600 hover:bg-teal-700 text-white">ğŸŒ åŒ¯å‡ºå‚™ä»½ (HTML)</button>
                    <button onclick="exportXLSX()" class="btn-blue bg-green-600 hover:bg-green-700 text-white">ğŸ“Š åŒ¯å‡º Excel</button>
                </div>
                <div class="border-l pl-2 flex gap-2">
                    <button onclick="printReport()" class="btn-gray">ğŸ–¨ï¸ åˆ—å°</button>
                    <button onclick="clearAll()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg font-medium shadow-sm border border-red-200">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>
        </div>
        <style>.btn-gray { @apply px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium flex items-center shadow-sm; } .btn-blue { @apply px-3 py-2 rounded-lg font-bold shadow flex items-center gap-1; }</style>
        <div id="report-title" class="hidden text-3xl font-bold text-center mb-8">è‡ºåŒ—å¸‚åŸºé‡‘114å¹´åº¦è²¡æ”¿æ”¶æ”¯è¦æ¨¡å½™ç¸½è¡¨</div>
        <div class="max-w-[95%] mx-auto space-y-8">
            <div class="section-card bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">æ”¿åºœåç¨±</label><input type="text" id="meta-org" class="w-full border-b-2" placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚æ”¿åºœ" oninput="autoSave()"></div>
                    <div><label class="block text-sm font-bold text-gray-700 mb-1">å¹´åº¦</label><input type="number" id="meta-year" value="114" class="w-full border-b-2" oninput="autoSave()"></div>
                    <div class="no-print"><label class="block text-sm font-bold text-gray-700 mb-1">å¡«è¡¨äºº</label><input type="text" id="meta-user" class="w-full border-b-2" placeholder="è«‹è¼¸å…¥å§“å" oninput="autoSave()"></div>
                </div>
            </div>
            <div class="section-card bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-blue-800">ğŸ¢ ç‡Ÿæ¥­åŸºé‡‘</h2><button onclick="addOperatingRow()" class="no-print bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 text-sm font-bold">+ æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="no-print w-8"></th><th>åŸºé‡‘åç¨±</th><th>ç‡Ÿæ¥­æ”¶å…¥</th><th>ç‡Ÿæ¥­æˆæœ¬</th><th>ç‡Ÿæ¥­æ¯›åˆ©</th><th>ç‡Ÿæ¥­è²»ç”¨</th><th>ç‡Ÿæ¥­åˆ©ç›Š</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>æ¥­å¤–åˆ©ç›Š</th><th>ç¨…å‰æ·¨åˆ©</th><th>æ‰€å¾—ç¨…</th><th>æœ¬æœŸæ·¨åˆ©</th></tr></thead><tbody id="tbody-op"></tbody></table></div>
            </div>
            <div class="section-card bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-green-800">ğŸ—ï¸ ä½œæ¥­åŸºé‡‘</h2><button onclick="addWorkingRow()" class="no-print bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200 text-sm font-bold">+ æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="no-print w-8"></th><th>åŸºé‡‘åç¨±</th><th>æ¥­å‹™æ”¶å…¥</th><th>æˆæœ¬è²»ç”¨</th><th>æ¥­å‹™è³¸é¤˜</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>æ¥­å¤–è³¸é¤˜</th><th>æœ¬æœŸè³¸é¤˜</th></tr></thead><tbody id="tbody-wk"></tbody></table></div>
            </div>
            <div class="section-card bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-purple-800">ğŸ’° ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘</h2><button onclick="addSpecialRow('special')" class="no-print bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 text-sm font-bold">+ æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="no-print w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>è§£ç¹³å…¬åº«</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="tbody-sp"></tbody></table></div>
            </div>
            <div class="section-card bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-orange-800">ğŸ“‰ å‚µå‹™åŸºé‡‘</h2><button onclick="addSpecialRow('debt')" class="no-print bg-orange-100 text-orange-700 px-3 py-1 rounded hover:bg-orange-200 text-sm font-bold">+ æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="no-print w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="tbody-debt"></tbody></table></div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', () => { loadFromStorage(); if(document.querySelectorAll('tbody tr').length === 0) { resetRows(); } });
            function resetRows() { ['tbody-op','tbody-wk','tbody-sp','tbody-debt'].forEach(id => document.getElementById(id).innerHTML = ''); addOperatingRow(); addWorkingRow(); addSpecialRow('special'); addSpecialRow('debt'); }
            function clearAll() { if(!confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ\næ­¤å‹•ä½œå°‡æ¸…é™¤ç•«é¢èˆ‡æš«å­˜æª”ï¼Œç„¡æ³•å¾©åŸã€‚')) return; localStorage.removeItem('fund_budget_draft'); document.getElementById('meta-org').value = ''; document.getElementById('meta-user').value = ''; resetRows(); document.getElementById('save-status').innerHTML = '<span class="text-red-500 font-bold">å·²æ¸…ç©º</span>'; setTimeout(() => autoSave(), 500); }
            function createInput(cls, val='', ro=false, oninp='') { return `<input type="${ro?'text':'number'}" class="${cls}" value="${val}" ${ro?'readonly':''} ${oninp?'oninput="'+oninp+'(this)"':''} placeholder="${ro?'':0}">`; }
            function addOperatingRow(d={}) { const tr=document.createElement('tr'); tr.innerHTML=`<td class="no-print text-center"><span class="del-btn" onclick="delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="autoSave()"></td><td>${createInput('v-rev',d.rev,0,'calcOp')}</td><td>${createInput('v-cost',d.cost,0,'calcOp')}</td><td>${createInput('v-gross',d.gross,1)}</td><td>${createInput('v-exp',d.exp,0,'calcOp')}</td><td>${createInput('v-opprofit',d.opprofit,1)}</td><td>${createInput('v-nonrev',d.nonrev,0,'calcOp')}</td><td>${createInput('v-nonexp',d.nonexp,0,'calcOp')}</td><td>${createInput('v-nonprofit',d.nonprofit,1)}</td><td>${createInput('v-pretax',d.pretax,1)}</td><td>${createInput('v-tax',d.tax,0,'calcOp')}</td><td><input class="v-net font-bold text-red-600" value="${d.net||''}" readonly></td>`; document.getElementById('tbody-op').appendChild(tr); if(d.rev) calcOp(tr.querySelector('.v-rev')); }
            function addWorkingRow(d={}) { const tr=document.createElement('tr'); tr.innerHTML=`<td class="no-print text-center"><span class="del-btn" onclick="delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="autoSave()"></td><td>${createInput('v-rev',d.rev,0,'calcWk')}</td><td>${createInput('v-cost',d.cost,0,'calcWk')}</td><td>${createInput('v-surplus',d.surplus,1)}</td><td>${createInput('v-nonrev',d.nonrev,0,'calcWk')}</td><td>${createInput('v-nonexp',d.nonexp,0,'calcWk')}</td><td>${createInput('v-nonsurplus',d.nonsurplus,1)}</td><td><input class="v-net font-bold text-green-600" value="${d.net||''}" readonly></td>`; document.getElementById('tbody-wk').appendChild(tr); if(d.rev) calcWk(tr.querySelector('.v-rev')); }
            function addSpecialRow(type,d={}) { const tr=document.createElement('tr'); const remit=type==='debt'?'<input type="hidden" class="v-remit" value="0">':`<td>${createInput('v-remit',d.remit,0,'calcSp')}</td>`; tr.innerHTML=`<td class="no-print text-center"><span class="del-btn" onclick="delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="autoSave()"></td><td>${createInput('v-source',d.source,0,'calcSp')}</td><td>${createInput('v-use',d.use,0,'calcSp')}</td><td>${createInput('v-surplus',d.surplus,1)}</td><td>${createInput('v-begin',d.begin,0,'calcSp')}</td>${remit}<td><input class="v-end font-bold" value="${d.end||''}" readonly></td>`; document.getElementById(type==='debt'?'tbody-debt':'tbody-sp').appendChild(tr); if(d.source) calcSp(tr.querySelector('.v-source')); }
            function delRow(btn) { if(confirm('åˆªé™¤ï¼Ÿ')) { btn.closest('tr').remove(); autoSave(); } }
            const val = (r,s) => parseFloat(r.querySelector(s)?.value)||0;
            const set = (r,s,v) => { if(r.querySelector(s)) r.querySelector(s).value = v; };
            function calcOp(e) { const r=e.closest('tr'); const g=val(r,'.v-rev')-val(r,'.v-cost'), op=g-val(r,'.v-exp'), np=val(r,'.v-nonrev')-val(r,'.v-nonexp'); set(r,'.v-gross',g); set(r,'.v-opprofit',op); set(r,'.v-nonprofit',np); set(r,'.v-pretax',op+np); set(r,'.v-net',op+np-val(r,'.v-tax')); autoSave(); }
            function calcWk(e) { const r=e.closest('tr'); const s=val(r,'.v-rev')-val(r,'.v-cost'), ns=val(r,'.v-nonrev')-val(r,'.v-nonexp'); set(r,'.v-surplus',s); set(r,'.v-nonsurplus',ns); set(r,'.v-net',s+ns); autoSave(); }
            function calcSp(e) { const r=e.closest('tr'); const s=val(r,'.v-source')-val(r,'.v-use'); set(r,'.v-surplus',s); set(r,'.v-end',val(r,'.v-begin')+s-val(r,'.v-remit')); autoSave(); }
            function getTS() { const d=new Date(); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}_${d.getHours().toString().padStart(2,'0')}${d.getMinutes().toString().padStart(2,'0')}`; }
            function exportHTML() { document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value)); const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML; const org = document.getElementById('meta-org').value || 'æœªå‘½å'; saveAs(new Blob([html], {type: "text/html;charset=utf-8"}), `${org}_é ç®—å‚™ä»½_${getTS()}.html`); }
            function exportJSON() { const d = collectData(); saveAs(new Blob([JSON.stringify(d,null,2)],{type:"application/json"}), `${d.metadata.org}_${d.metadata.year}_${getTS()}.json`); }
            function exportXLSX() { const d = collectData(); const wb = XLSX.utils.book_new(); const org = d.metadata.org || 'æœªå‘½å'; const createSheet = (name, data, headers) => { if(!data || data.length === 0) return; const wsData = [headers]; data.forEach(item => { const row = headers.map((_, i) => { if(name.includes('ç‡Ÿæ¥­')) return [item.name, item.rev, item.cost, item.gross, item.exp, item.opprofit, item.nonrev, item.nonexp, item.nonprofit, item.pretax, item.tax, item.net][i]; if(name.includes('ä½œæ¥­')) return [item.name, item.rev, item.cost, item.surplus, item.nonrev, item.nonexp, item.nonsurplus, item.net][i]; if(name.includes('ç‰¹åˆ¥')) return [item.name, item.source, item.use, item.surplus, item.begin, item.remit, item.end][i]; if(name.includes('å‚µå‹™')) return [item.name, item.source, item.use, item.surplus, item.begin, item.end][i]; return ''; }); wsData.push(row); }); const ws = XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb, ws, name); }; createSheet('ç‡Ÿæ¥­åŸºé‡‘', d.op, ['åŸºé‡‘åç¨±','ç‡Ÿæ¥­æ”¶å…¥','ç‡Ÿæ¥­æˆæœ¬','ç‡Ÿæ¥­æ¯›åˆ©','ç‡Ÿæ¥­è²»ç”¨','ç‡Ÿæ¥­åˆ©ç›Š','æ¥­å¤–æ”¶å…¥','æ¥­å¤–è²»ç”¨','æ¥­å¤–åˆ©ç›Š','ç¨…å‰æ·¨åˆ©','æ‰€å¾—ç¨…','æœ¬æœŸæ·¨åˆ©']); createSheet('ä½œæ¥­åŸºé‡‘', d.wk, ['åŸºé‡‘åç¨±','æ¥­å‹™æ”¶å…¥','æˆæœ¬è²»ç”¨','æ¥­å‹™è³¸é¤˜','æ¥­å¤–æ”¶å…¥','æ¥­å¤–è²»ç”¨','æ¥­å¤–è³¸é¤˜','æœ¬æœŸè³¸é¤˜']); createSheet('ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘', d.sp, ['åŸºé‡‘åç¨±','åŸºé‡‘ä¾†æº','åŸºé‡‘ç”¨é€”','æœ¬æœŸè³¸é¤˜','æœŸåˆç´¯ç©','è§£ç¹³å…¬åº«','æœŸæœ«ç´¯ç©']); createSheet('å‚µå‹™åŸºé‡‘', d.debt, ['åŸºé‡‘åç¨±','åŸºé‡‘ä¾†æº','åŸºé‡‘ç”¨é€”','æœ¬æœŸè³¸é¤˜','æœŸåˆç´¯ç©','æœŸæœ«ç´¯ç©']); XLSX.writeFile(wb, `${org}_é ç®—è¡¨_${getTS()}.xlsx`); }
            function importFile(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; const fileName = file.name.toLowerCase(); if(fileName.endsWith('.json')) { try { const data = JSON.parse(content); populateUI(data); autoSave(); alert('JSON è³‡æ–™å·²æˆåŠŸåŒ¯å…¥ï¼'); } catch(err) { alert('JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è®€å–ã€‚'); } } else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) { try { const doc = new DOMParser().parseFromString(content, 'text/html'); document.getElementById('meta-org').value = doc.getElementById('meta-org').value; document.getElementById('meta-year').value = doc.getElementById('meta-year').value; document.getElementById('meta-user').value = doc.getElementById('meta-user').value; resetRows(); ['tbody-op','tbody-wk','tbody-sp','tbody-debt'].forEach(id => document.getElementById(id).innerHTML = ''); const g = (tr, s) => tr.querySelector(s)?.getAttribute('value') || tr.querySelector(s)?.value || ''; doc.querySelectorAll('#tbody-op tr').forEach(tr => addOperatingRow({name:g(tr,'.name-input'), rev:g(tr,'.v-rev'), cost:g(tr,'.v-cost'), exp:g(tr,'.v-exp'), nonrev:g(tr,'.v-nonrev'), nonexp:g(tr,'.v-nonexp'), tax:g(tr,'.v-tax')})); doc.querySelectorAll('#tbody-wk tr').forEach(tr => addWorkingRow({name:g(tr,'.name-input'), rev:g(tr,'.v-rev'), cost:g(tr,'.v-cost'), nonrev:g(tr,'.v-nonrev'), nonexp:g(tr,'.v-nonexp')})); doc.querySelectorAll('#tbody-sp tr').forEach(tr => addSpecialRow('special',{name:g(tr,'.name-input'), source:g(tr,'.v-source'), use:g(tr,'.v-use'), begin:g(tr,'.v-begin'), remit:g(tr,'.v-remit')})); doc.querySelectorAll('#tbody-debt tr').forEach(tr => addSpecialRow('debt',{name:g(tr,'.name-input'), source:g(tr,'.v-source'), use:g(tr,'.v-use'), begin:g(tr,'.v-begin')})); autoSave(); alert('HTML å‚™ä»½å·²æˆåŠŸåŒ¯å…¥ï¼'); } catch(err) { alert('HTML è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ç‚ºæœ¬ç³»çµ±ç”¢ç”Ÿçš„å‚™ä»½æª”ã€‚'); } } else { alert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ .json æˆ– .html'); } }; reader.readAsText(file); input.value = ''; }
            function autoSave() { const d = collectData(); localStorage.setItem('fund_budget_draft', JSON.stringify(d)); document.getElementById('save-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>å·²å„²å­˜'; }
            function loadFromStorage() { const s=localStorage.getItem('fund_budget_draft'); if(s) populateUI(JSON.parse(s)); }
            function collectData() { const scrape = (id, fields) => Array.from(document.querySelectorAll(`#${id} tr`)).map(r => { let o={}; fields.forEach(f=>o[f.key]=r.querySelector(f.sel)?.value); return o.name?o:null; }).filter(x=>x); return { metadata: { org: document.getElementById('meta-org').value, year: document.getElementById('meta-year').value, user: document.getElementById('meta-user').value }, op: scrape('tbody-op', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'exp',sel:'.v-exp'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'tax',sel:'.v-tax'},{key:'gross',sel:'.v-gross'},{key:'opprofit',sel:'.v-opprofit'},{key:'nonprofit',sel:'.v-nonprofit'},{key:'pretax',sel:'.v-pretax'},{key:'net',sel:'.v-net'}]), wk: scrape('tbody-wk', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'surplus',sel:'.v-surplus'},{key:'nonsurplus',sel:'.v-nonsurplus'},{key:'net',sel:'.v-net'}]), sp: scrape('tbody-sp', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'remit',sel:'.v-remit'},{key:'surplus',sel:'.v-surplus'},{key:'end',sel:'.v-end'}]), debt: scrape('tbody-debt', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'surplus',sel:'.v-surplus'},{key:'end',sel:'.v-end'}]) }; }
            function populateUI(d) { document.getElementById('meta-org').value = d.metadata.org; document.getElementById('meta-year').value = d.metadata.year; document.getElementById('meta-user').value = d.metadata.user; resetRows(); ['tbody-op','tbody-wk','tbody-sp','tbody-debt'].forEach(id => document.getElementById(id).innerHTML = ''); d.op?.forEach(i=>addOperatingRow(i)); d.wk?.forEach(i=>addWorkingRow(i)); d.sp?.forEach(i=>addSpecialRow('special',i)); d.debt?.forEach(i=>addSpecialRow('debt',i)); }
            function printReport() { window.print(); }
        </script>
        </body>
        </html>
    </script>

    <script id="template-dashboard" type="text/template">
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>å…¨åœ‹/ç›´è½„å¸‚ é ç®—å¤§æ•¸æ“šåŒ¯æ•´ä¸­å¿ƒ</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
                body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; color: white; }
                .drop-zone { border: 3px dashed #475569; transition: all 0.3s; background-color: #1e293b; position: relative; }
                .drop-zone.active { border-color: #38bdf8; background-color: #334155; transform: scale(1.01); }
                .drop-zone * { pointer-events: none; }
                .data-table th { background-color: #334155; color: #94a3b8; padding: 12px; font-size: 0.85rem; text-align: left; }
                .data-table td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.9rem; }
                .data-table tr:hover { background-color: #1e293b; }
                th.sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
                th.sortable:hover { background-color: #475569; color: white; }
                th.sortable::after { content: ' â†•'; font-size: 0.8em; opacity: 0.3; float: right; }
                th.sortable.asc::after { content: ' â†‘'; opacity: 1; color: #38bdf8; }
                th.sortable.desc::after { content: ' â†“'; opacity: 1; color: #38bdf8; }
                .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
                .stat-label { font-size: 0.875rem; color: #94a3b8; margin-bottom: 0.5rem; }
                .stat-value { font-size: 2rem; font-weight: 700; color: white; }
                .search-input { background-color: #1e293b; border: 1px solid #475569; color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; width: 100%; transition: border-color 0.2s; }
                .search-input:focus { outline: none; border-color: #38bdf8; ring: 2px solid #0ea5e9; }
            </style>
        </head>
        <body class="p-6 md:p-10 min-h-screen">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-wrap justify-between items-end mb-10 gap-4">
                <div><h1 class="text-4xl font-bold text-white mb-2">ğŸ‡¹ğŸ‡¼ å…¨åœ‹é ç®—åŒ¯æ•´å„€è¡¨æ¿</h1><p class="text-slate-400">æ”¯æ´ JSONã€HTML å‚™ä»½æª”ï¼Œå…·å‚™å…¨å£å¾‘ç¸½æ”¶æ”¯è¨ˆç®—</p></div>
                <div class="flex gap-2">
                    <button onclick="triggerFileSelect()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-slate-300 font-medium flex items-center gap-2 border border-slate-600">ğŸ“‚ é¸æ“‡æª”æ¡ˆ</button>
                    <button onclick="exportWorkspaceHTML()" class="px-4 py-2 bg-teal-600 hover:bg-teal-500 rounded-lg text-white font-bold shadow-lg flex items-center gap-2">ğŸŒ å„²å­˜å·¥ä½œå€</button>
                    <button onclick="clearAll()" class="px-4 py-2 bg-red-900/50 hover:bg-red-900 rounded-lg text-red-200 font-medium border border-red-800">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>
            <div class="drop-zone rounded-2xl p-12 text-center cursor-pointer mb-10" id="dropZone">
                <div class="text-5xl mb-4">ğŸ“‚</div>
                <p class="text-xl text-slate-200 font-bold">è«‹å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤</p>
                <p class="text-sm text-slate-500 mt-2">æ”¯æ´æ ¼å¼ï¼š.json, .html</p>
                <input type="file" id="fileInput" multiple accept=".json, .html, .htm" class="hidden" onchange="handleFiles(this.files)">
            </div>
            <div id="dashboard" class="hidden space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="stat-card border-l-4 border-blue-500"><div class="stat-label">æ”¿åºœæ•¸é‡</div><div class="stat-value" id="kpi-govs">0</div></div>
                    <div class="stat-card border-l-4 border-indigo-500"><div class="stat-label">åŸºé‡‘ç¸½å®¶æ•¸</div><div class="stat-value" id="kpi-funds">0</div></div>
                    <div class="stat-card border-l-4 border-green-500"><div class="stat-label">å…¨åœ‹ç¸½æ”¶å…¥ (å„„)</div><div class="stat-value text-green-400" id="kpi-rev">0</div></div>
                    <div class="stat-card border-l-4 border-emerald-500"><div class="stat-label">å…¨åœ‹ç¸½è³¸é¤˜ (å„„)</div><div class="stat-value text-emerald-400" id="kpi-surplus">0</div></div>
                    <div class="stat-card border-l-4 border-teal-500"><div class="stat-label">ç›ˆé¤˜(è³¸é¤˜)å®¶æ•¸</div><div class="stat-value text-teal-300" id="kpi-profit-count">0</div></div>
                    <div class="stat-card border-l-4 border-red-500"><div class="stat-label">è™§æ(çŸ­çµ€)å®¶æ•¸</div><div class="stat-value text-red-400" id="kpi-loss-count">0</div></div>
                </div>
                <div class="bg-[#1e293b] rounded-xl p-6 border border-slate-700">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">ğŸ” åŸºé‡‘ç´°é …æŸ¥è©¢ (å…¨å£å¾‘ç¸½é¡)</h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <select id="filter-gov" class="search-input" onchange="performSearch()"><option value="all">ğŸ¢ æ‰€æœ‰åœ°æ–¹æ”¿åºœ (é¡¯ç¤ºå…¨éƒ¨)</option></select>
                        <input type="text" id="search-fund" placeholder="æœå°‹åŸºé‡‘åç¨±..." class="search-input" oninput="performSearch()">
                        <select id="search-type" class="search-input" onchange="performSearch()"><option value="all">ğŸ“‚ æ‰€æœ‰åŸºé‡‘é¡å‹</option><option value="op">ç‡Ÿæ¥­åŸºé‡‘</option><option value="wk">ä½œæ¥­åŸºé‡‘</option><option value="sp">ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘</option><option value="debt">å‚µå‹™åŸºé‡‘</option></select>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto border border-slate-700 rounded-lg">
                        <table class="w-full data-table text-left text-slate-300">
                            <thead class="sticky top-0 z-10 shadow-lg"><tr><th class="sortable" onclick="sortSearch('gov')">æ”¿åºœ</th><th class="sortable" onclick="sortSearch('type')">é¡å‹</th><th class="sortable" onclick="sortSearch('name')">åŸºé‡‘åç¨±</th><th class="sortable text-right" onclick="sortSearch('rev')">ç¸½æ”¶å…¥/ä¾†æº</th><th class="sortable text-right" onclick="sortSearch('exp')">ç¸½æ”¯å‡º/ç”¨é€”</th><th class="sortable text-right" onclick="sortSearch('net')">æœ¬æœŸç›ˆè™§/è³¸é¤˜</th></tr></thead>
                            <tbody id="search-results-body"><tr><td colspan="6" class="text-center py-8">è¼‰å…¥ä¸­...</td></tr></tbody>
                        </table>
                    </div>
                    <div class="text-right text-xs text-slate-500 mt-2" id="search-stats">0 ç­†çµæœ</div>
                </div>
                <div class="bg-[#1e293b] rounded-xl overflow-hidden shadow-xl border border-slate-700">
                    <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-white">ğŸ›ï¸ å„åœ°æ–¹æ”¿åºœè²¡æ”¿æ¦‚æ³</h3>
                        <button onclick="exportMasterExcel()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white font-bold text-sm shadow flex items-center gap-1">ğŸ“Š åŒ¯å‡º Excel</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full data-table text-left text-slate-300">
                            <thead><tr><th class="sortable" onclick="sortGov('org')">åœ°æ–¹æ”¿åºœ</th><th class="sortable" onclick="sortGov('opNet')">ç‡Ÿæ¥­åŸºé‡‘æ·¨åˆ©</th><th class="sortable" onclick="sortGov('wkNet')">ä½œæ¥­åŸºé‡‘è³¸é¤˜</th><th class="sortable" onclick="sortGov('spSurplus')">ç‰¹åˆ¥æ”¶å…¥è³¸é¤˜</th><th class="sortable" onclick="sortGov('debtEnd')">å‚µå‹™åŸºé‡‘æœŸæœ«</th><th class="sortable" onclick="sortGov('totalPerf')">ç¶œåˆè©•ä¼°</th></tr></thead>
                            <tbody id="gov-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script>
            let nationalData = []; let searchDataCache = []; let govSortState = { key: 'org', dir: 'desc' }; let searchSortState = { key: 'net', dir: 'desc' };
            document.addEventListener('DOMContentLoaded', () => { if (window.embeddedData && window.embeddedData.length > 0) { nationalData = window.embeddedData; updateDashboard(); } setupDragAndDrop(); });
            function setupDragAndDrop() { const dropZone = document.getElementById('dropZone'); ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => { dropZone.addEventListener(e, preventDefaults, false); document.body.addEventListener(e, preventDefaults, false); }); ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('active'), false)); ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('active'), false)); dropZone.addEventListener('drop', handleDrop, false); dropZone.addEventListener('click', triggerFileSelect); }
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            function handleDrop(e) { handleFiles(e.dataTransfer.files); }
            function triggerFileSelect() { document.getElementById('fileInput').click(); }
            function handleFiles(files) { Array.from(files).forEach(file => { const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; const name = file.name.toLowerCase(); if (name.endsWith('.json')) { try { const json = JSON.parse(content); if(json.metadata) processGovData(json); } catch(e){} } else if (name.endsWith('.html') || name.endsWith('.htm')) { parseHTMLFile(content); } }; reader.readAsText(file); }); }
            function parseHTMLFile(html) { const match = html.match(/window\.embeddedData = (\[.*?\]);/s); if(match && match[1]) { try{ JSON.parse(match[1]).forEach(j=>processGovData(j)); return; }catch(e){} } const doc = new DOMParser().parseFromString(html, 'text/html'); if (doc.getElementById('meta-org')) { const data = scrapeCounty(doc); if(data) processGovData(data); } }
            function scrapeCounty(doc) { const val = (r,s) => { const el=r.querySelector(s); return el?(el.getAttribute('value')||el.value||''):''; }; const meta = { org: doc.getElementById('meta-org').value || doc.getElementById('meta-org').getAttribute('value'), year: doc.getElementById('meta-year').value || doc.getElementById('meta-year').getAttribute('value'), user: doc.getElementById('meta-user').value || doc.getElementById('meta-user').getAttribute('value') }; if(!meta.org) return null; const scrapeRows = (id, fields) => Array.from(doc.querySelectorAll(`#${id} tr`)).map(tr => { let o={}; fields.forEach(k => o[k] = val(tr, `.v-${k}`) || val(tr, `.${k}-input`)); o.name = val(tr, '.name-input'); return o; }).filter(x=>x.name); return { metadata: meta, op: scrapeRows('tbody-op', ['rev','cost','exp','nonrev','nonexp','tax','net']), wk: scrapeRows('tbody-wk', ['rev','cost','nonrev','nonexp','net']), sp: scrapeRows('tbody-sp', ['source','use','surplus']), debt: scrapeRows('tbody-debt', ['source','use','end','surplus']) }; }
            function processGovData(json) { const idx = nationalData.findIndex(g => g.metadata.org === json.metadata.org); if(idx >= 0) nationalData[idx] = json; else nationalData.push(json); updateDashboard(); }
            function updateDashboard() { if(nationalData.length === 0) return; document.getElementById('dashboard').classList.remove('hidden'); refreshGovDropdown(); let stats = { govs: nationalData.length, funds: 0, rev: 0, surplus: 0, profitCount: 0, lossCount: 0 }; const num = (v) => parseFloat(v) || 0; const getFundTotals = (f, type) => { let i=0, o=0, n=0; if(type==='op') { i = num(f.rev)+num(f.nonrev); o = num(f.cost)+num(f.exp)+num(f.nonexp)+num(f.tax); n = num(f.net); } else if(type==='wk') { i = num(f.rev)+num(f.nonrev); o = num(f.cost)+num(f.nonexp); n = num(f.net); } else { i = num(f.source); o = num(f.use); n = num(f.surplus); } return { i, o, n }; }; nationalData.forEach(gov => { const processList = (list, type) => { if(!list) return; list.forEach(f => { const t = getFundTotals(f, type); stats.funds++; stats.rev += t.i; stats.surplus += t.n; if(t.n >= 0) stats.profitCount++; else stats.lossCount++; }); }; processList(gov.op, 'op'); processList(gov.wk, 'wk'); processList(gov.sp, 'sp'); if(gov.debt) gov.debt.forEach(f => { stats.funds++; if(num(f.surplus)>=0) stats.profitCount++; else stats.lossCount++; }); }); document.getElementById('kpi-govs').textContent = stats.govs; document.getElementById('kpi-funds').textContent = stats.funds; document.getElementById('kpi-rev').textContent = (stats.rev/100000).toFixed(2); document.getElementById('kpi-surplus').textContent = (stats.surplus/100000).toFixed(2); document.getElementById('kpi-profit-count').textContent = stats.profitCount; document.getElementById('kpi-loss-count').textContent = stats.lossCount; renderGovTable(); performSearch(); }
            function refreshGovDropdown() { const select = document.getElementById('filter-gov'); const currentVal = select.value; select.innerHTML = '<option value="all">ğŸ¢ æ‰€æœ‰åœ°æ–¹æ”¿åºœ (é¡¯ç¤ºå…¨éƒ¨)</option>'; const sortedGovs = [...nationalData].sort((a,b) => a.metadata.org.localeCompare(b.metadata.org, 'zh-Hant')); sortedGovs.forEach(gov => { const opt = document.createElement('option'); opt.value = gov.metadata.org; opt.textContent = gov.metadata.org; select.appendChild(opt); }); if(nationalData.some(g => g.metadata.org === currentVal)) select.value = currentVal; }
            function performSearch() { const govFilter = document.getElementById('filter-gov').value; const fundKey = document.getElementById('search-fund').value.toLowerCase(); const typeKey = document.getElementById('search-type').value; const num = (v) => parseFloat(v) || 0; searchDataCache = []; nationalData.forEach(gov => { if (govFilter !== 'all' && gov.metadata.org !== govFilter) return; const process = (list, typeCode, typeName) => { if (typeKey !== 'all' && typeKey !== typeCode) return; list?.forEach(f => { if (fundKey && !f.name.toLowerCase().includes(fundKey)) return; let inc=0, out=0, bal=0; if (typeCode === 'op') { inc = num(f.rev) + num(f.nonrev); out = num(f.cost) + num(f.exp) + num(f.nonexp) + num(f.tax); bal = num(f.net); } else if (typeCode === 'wk') { inc = num(f.rev) + num(f.nonrev); out = num(f.cost) + num(f.nonexp); bal = num(f.net); } else { inc = num(f.source); out = num(f.use); bal = num(f.surplus); } searchDataCache.push({ gov: gov.metadata.org, type: typeName, name: f.name, rev: inc, exp: out, net: bal }); }); }; process(gov.op, 'op', 'ç‡Ÿæ¥­'); process(gov.wk, 'wk', 'ä½œæ¥­'); process(gov.sp, 'sp', 'ç‰¹æ”¶'); process(gov.debt, 'debt', 'å‚µå‹™'); }); renderSearchTable(); }
            function renderSearchTable() { const tbody = document.getElementById('search-results-body'); tbody.innerHTML = ''; const key = searchSortState.key; const dir = searchSortState.dir === 'asc' ? 1 : -1; searchDataCache.sort((a,b) => { if (['gov','type','name'].includes(key)) return a[key].localeCompare(b[key], 'zh-Hant') * dir; return (a[key] - b[key]) * dir; }); updateSortIcons('search-results-body', searchSortState); if(searchDataCache.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-slate-500 py-8">æ‰¾ä¸åˆ°ç¬¦åˆçš„åŸºé‡‘</td></tr>'; document.getElementById('search-stats').textContent = '0 ç­†çµæœ'; return; } searchDataCache.forEach(row => { const color = row.net >= 0 ? 'text-green-400' : 'text-red-400'; tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-700/50"><td class="text-slate-200">${row.gov}</td><td><span class="text-xs px-2 py-1 rounded bg-slate-600 text-slate-300">${row.type}</span></td><td class="font-medium text-white">${row.name}</td><td class="text-right font-mono text-slate-300">${row.rev.toLocaleString()}</td><td class="text-right font-mono text-slate-300">${row.exp.toLocaleString()}</td><td class="text-right font-mono font-bold ${color}">${row.net.toLocaleString()}</td></tr>`; }); document.getElementById('search-stats').textContent = `é¡¯ç¤º ${searchDataCache.length} ç­†çµæœ`; }
            function renderGovTable() { const tbody = document.getElementById('gov-table-body'); tbody.innerHTML = ''; const num = (v) => parseFloat(v) || 0; const sum = (arr, k) => arr ? arr.reduce((a,i)=>a+num(i[k]),0) : 0; let displayData = nationalData.map(gov => ({ org: gov.metadata.org, opNet: sum(gov.op, 'net'), wkNet: sum(gov.wk, 'net'), spSurplus: sum(gov.sp, 'surplus'), debtEnd: sum(gov.debt, 'end'), totalPerf: sum(gov.op, 'net') + sum(gov.wk, 'net') + sum(gov.sp, 'surplus') })); const key = govSortState.key; const dir = govSortState.dir === 'asc' ? 1 : -1; displayData.sort((a,b) => { if (key === 'org') return a.org.localeCompare(b.org, 'zh-Hant') * dir; return (a[key] - b[key]) * dir; }); updateSortIcons('gov-table-body', govSortState); displayData.forEach(row => { tbody.innerHTML += `<tr><td class="font-bold text-white">${row.org}</td><td class="${row.opNet>=0?'text-green-300':'text-red-300'}">${row.opNet.toLocaleString()}</td><td class="${row.wkNet>=0?'text-green-300':'text-red-300'}">${row.wkNet.toLocaleString()}</td><td class="${row.spSurplus>=0?'text-green-300':'text-red-300'}">${row.spSurplus.toLocaleString()}</td><td class="text-orange-300">${row.debtEnd.toLocaleString()}</td><td class="${row.totalPerf>=0?'text-green-400':'text-red-400'} font-bold">${row.totalPerf>=0?'ğŸ“ˆ ç›ˆé¤˜':'ğŸ“‰ çŸ­çµ€'}</td></tr>`; }); }
            function sortSearch(key) { searchSortState.dir = (searchSortState.key === key && searchSortState.dir === 'desc') ? 'asc' : 'desc'; searchSortState.key = key; renderSearchTable(); }
            function sortGov(key) { govSortState.dir = (govSortState.key === key && govSortState.dir === 'desc') ? 'asc' : 'desc'; govSortState.key = key; renderGovTable(); }
            function updateSortIcons(tid, s) { document.getElementById(tid).parentNode.querySelectorAll('th.sortable').forEach(th => { th.classList.remove('asc','desc'); if(th.getAttribute('onclick').includes(`'${s.key}'`)) th.classList.add(s.dir); }); }
            function clearAll() { if(!confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) return; nationalData=[]; window.embeddedData=[]; document.getElementById('dashboard').classList.add('hidden'); document.getElementById('fileInput').value=''; }
            function getTS() { const d=new Date(); return `${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}_${d.getHours().toString().padStart(2,'0')}`; }
            function exportWorkspaceHTML() { const s=`<script>window.embeddedData = ${JSON.stringify(nationalData)};<\/script>`; let h=document.documentElement.outerHTML.replace(/<script>window\.embeddedData = .*?<\/script>/s,''); let p=h.lastIndexOf('</body>'); saveAs(new Blob([h.substring(0,p)+s+h.substring(p)],{type:"text/html"}), `å…¨åœ‹é ç®—åŒ¯æ•´å·¥ä½œå€_${getTS()}.html`); }
            function exportMasterExcel() { const wb = XLSX.utils.book_new(); const num = (v) => parseFloat(v) || 0; const sumData = [['åœ°æ–¹æ”¿åºœ', 'ç‡Ÿæ¥­åŸºé‡‘æ·¨åˆ©', 'ä½œæ¥­åŸºé‡‘è³¸é¤˜', 'ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘è³¸é¤˜', 'å‚µå‹™åŸºé‡‘æœŸæœ«ç´¯ç©', 'åˆè¨ˆæç›Š']]; nationalData.forEach(gov => { const sum = (arr, k) => arr ? arr.reduce((a,i)=>a+num(i[k]),0) : 0; const op=sum(gov.op,'net'), wk=sum(gov.wk,'net'), sp=sum(gov.sp,'surplus'), debt=sum(gov.debt,'end'); sumData.push([gov.metadata.org, op, wk, sp, debt, op+wk+sp]); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sumData), "å„ç¸£å¸‚æ¯”è¼ƒç¸½è¡¨"); const details = [['ç¸£å¸‚', 'é¡å‹', 'åŸºé‡‘åç¨±', 'ç¸½æ”¶å…¥/ä¾†æº', 'ç¸½æ”¯å‡º/ç”¨é€”', 'æœ¬æœŸç›ˆè™§/è³¸é¤˜']]; const pushRows = (gov, list, type, typeCode) => list?.forEach(f => { let inc=0, out=0, bal=0; if (typeCode === 'op') { inc = num(f.rev)+num(f.nonrev); out = num(f.cost)+num(f.exp)+num(f.nonexp)+num(f.tax); bal = num(f.net); } else if (typeCode === 'wk') { inc = num(f.rev)+num(f.nonrev); out = num(f.cost)+num(f.nonexp); bal = num(f.net); } else { inc = num(f.source); out = num(f.use); bal = num(f.surplus); } details.push([gov.metadata.org, type, f.name, inc, out, bal]); }); nationalData.forEach(g => { pushRows(g, g.op, 'ç‡Ÿæ¥­', 'op'); pushRows(g, g.wk, 'ä½œæ¥­', 'wk'); pushRows(g, g.sp, 'ç‰¹æ”¶', 'sp'); pushRows(g, g.debt, 'å‚µå‹™', 'debt'); }); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(details), "æ‰€æœ‰åŸºé‡‘æ˜ç´°"); XLSX.writeFile(wb, `å…¨åœ‹ç›´è½„å¸‚ç¸£å¸‚_åŸºé‡‘é ç®—ç¸½è¡¨_${getTS()}.xlsx`); }
        </script>
        </body>
        </html>
    </script>
</body>
</html>
