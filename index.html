<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—æ”¶æ”¯å¡«å ±èˆ‡åŒ¯æ•´ç³»çµ± (v3.4.5 å…¨åŠŸèƒ½æ•´åˆç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        
        /* Tooltips */
        .btn-tooltip { position: relative; }
        .btn-tooltip::after {
            content: attr(data-tooltip); position: absolute; top: 125%; left: 50%; transform: translateX(-50%);
            background-color: #1e293b; color: #fff; padding: 6px 10px; border-radius: 6px;
            font-size: 0.75rem; white-space: nowrap; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 50;
        }
        .btn-tooltip:hover::after { opacity: 1; visibility: visible; top: 115%; }

        [data-input-tip]:hover::after {
            content: attr(data-input-tip); position: absolute; bottom: 100%; left: 0;
            background: #334155; color: white; padding: 3px 8px; border-radius: 4px;
            font-size: 0.7rem; white-space: nowrap; z-index: 100; pointer-events: none;
        }

        /* Tables */
        .budget-table th { background-color: #e2e8f0; padding: 8px; font-size: 0.85rem; border: 1px solid #cbd5e1; white-space: nowrap; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 100px; }
        .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
        .budget-table input[readonly] { font-weight: bold; }
        
        .negative-value { color: #dc2626 !important; font-weight: bold; }
        .total-row { background-color: #f1f5f9; font-weight: bold; }

        .drop-zone { border: 3px dashed #475569; transition: 0.3s; background-color: #1e293b; }
        .drop-zone.active { border-color: #38bdf8; background-color: #334155; }
        .agg-table th { background-color: #334155; color: #94a3b8; padding: 12px; font-size: 0.85rem; }
        .agg-table td { padding: 12px; border-bottom: 1px solid #334155; color: #e2e8f0; }
        .stat-card { background: #1e293b; border-radius: 12px; padding: 20px; border: 1px solid #334155; }
    </style>
</head>
<body>

<nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl">ğŸ‡¹ğŸ‡¼</div>
            <div>
                <h1 class="font-bold text-lg text-slate-800">æ”¿åºœé ç®—æŸ¥å¡«åŒ¯æ•´å¹³è‡º</h1>
                <p class="text-xs text-slate-500">v3.4.5 å…¨åŠŸèƒ½ç‰ˆ</p>
            </div>
        </div>
        <div class="tab-pill-container bg-slate-100 p-1 rounded-full flex">
            <button onclick="switchTab('manager')" id="btn-manager" class="px-6 py-2 rounded-full font-bold text-slate-500 transition active">ğŸ“ å¡«å ±ç«™</button>
            <button onclick="switchTab('aggregator')" id="btn-aggregator" class="px-6 py-2 rounded-full font-bold text-slate-500 transition">ğŸ“Š åŒ¯æ•´ç«¯</button>
        </div>
    </div>
</nav>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 block">
    <div class="bg-white p-4 rounded-xl shadow mb-6 flex justify-between items-center border border-slate-200">
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">ğŸ“ å¡«å ±å·¥ä½œç«™ <span class="text-xs font-normal text-blue-500 bg-blue-50 px-2 py-1 rounded-full border border-blue-100">ğŸ’¡ æ”¯æ´ Excel è²¼ä¸Šèˆ‡è‡ªå‹•åˆè¨ˆ</span></h2>
        <div class="flex gap-2">
            <button onclick="mgr_exportHTML()" class="bg-teal-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-teal-700">ğŸŒ å‚™ä»½ HTML</button>
            <button onclick="mgr_exportXLSX()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-green-700">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_clearAll()" class="text-red-500 px-3 py-2 border border-red-100 rounded text-sm hover:bg-red-50">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div class="space-y-6" id="sections-container">
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-3 gap-6">
            <input type="text" id="mgr-org" class="border-b-2 p-2 outline-none focus:border-blue-500 font-bold text-lg" placeholder="æ©Ÿé—œåç¨±" oninput="mgr_autoSave()">
            <input type="number" id="mgr-year" class="border-b-2 p-2 outline-none" value="115" oninput="mgr_autoSave()">
            <input type="text" id="mgr-user" class="border-b-2 p-2 outline-none" placeholder="å¡«è¡¨äºº" oninput="mgr_autoSave()">
        </div>
        </div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-6 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-6">
        <div><h1 class="text-3xl font-bold">ğŸ“Š åŒ¯æ•´å„€è¡¨æ¿</h1><p class="text-slate-400">Level 2 è·¨å–®ä½è‡ªå‹•æ•´åˆ</p></div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('agg-input').click()" class="bg-slate-700 px-4 py-2 rounded-lg text-sm font-bold border border-slate-600">ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ</button>
            <input type="file" id="agg-input" multiple accept=".json,.html" class="hidden" onchange="agg_handleFiles(this.files)">
            <button onclick="agg_clearAll()" class="bg-red-900/40 text-red-200 px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div id="agg-dropzone" class="drop-zone p-12 text-center cursor-pointer mb-8 rounded-xl">
        <p class="text-xl font-bold text-slate-300">ğŸ“¥ æ‹–æ›³å„æ©Ÿé—œå›å‚³çš„ HTML æˆ– JSON æª”è‡³æ­¤</p>
    </div>

    <div id="agg-content" class="hidden space-y-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="stat-card border-l-4 border-blue-500"><div class="text-slate-400 text-xs font-bold uppercase">åŒ¯æ•´å–®ä½</div><div class="text-2xl font-bold mt-1" id="kpi-govs">0</div></div>
            <div class="stat-card border-l-4 border-green-500"><div class="text-slate-400 text-xs font-bold uppercase">ç¸½æ”¶å…¥(å„„)</div><div class="text-2xl font-bold mt-1 text-green-400" id="kpi-rev">0</div></div>
            <div class="stat-card border-l-4 border-emerald-500"><div class="text-slate-400 text-xs font-bold uppercase">ç¸½è³¸é¤˜(å„„)</div><div class="text-2xl font-bold mt-1 text-emerald-400" id="kpi-surplus">0</div></div>
            <div class="stat-card border-l-4 border-red-500"><div class="text-slate-400 text-xs font-bold uppercase">è™§æå®¶æ•¸</div><div class="text-2xl font-bold mt-1 text-red-400" id="kpi-loss">0</div></div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <select id="agg-filter-gov" class="bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none" onchange="agg_search()"><option value="all">ğŸ¢ æ‰€æœ‰å–®ä½</option></select>
                <input type="text" id="agg-search-txt" placeholder="æœå°‹åŸºé‡‘..." class="bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none" oninput="agg_search()">
                <select id="agg-filter-type" class="bg-slate-900 border border-slate-600 rounded-lg p-2 text-white outline-none" onchange="agg_search()">
                    <option value="all">ğŸ“‚ æ‰€æœ‰é¡å‹</option><option value="op">ç‡Ÿæ¥­</option><option value="wk">ä½œæ¥­</option><option value="sp">ç‰¹æ”¶</option><option value="db">å‚µå‹™</option><option value="cp">è³‡æœ¬</option>
                </select>
            </div>
            <div class="overflow-x-auto max-h-96 border border-slate-700 rounded-lg">
                <table class="w-full agg-table text-left text-sm">
                    <thead class="sticky top-0 bg-slate-900 z-10 shadow">
                        <tr><th>æ©Ÿé—œ</th><th>é¡å‹</th><th>åç¨±</th><th class="text-right">ç¸½æ”¶å…¥</th><th class="text-right">ç›ˆè™§</th></tr>
                    </thead>
                    <tbody id="agg-search-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // é…ç½®å®šç¾©
    const sectionConfigs = [
        { id: 'op', title: 'ä¸€ã€ç‡Ÿæ¥­åŸºé‡‘', color: '#2563eb', fields: ['name','rev','cost','gross','exp','opprofit','pretax','tax','net'] },
        { id: 'wk', title: 'äºŒã€ä½œæ¥­åŸºé‡‘', color: '#16a34a', fields: ['name','rev','cost','surplus','non','net'] },
        { id: 'sp', title: 'ä¸‰ã€ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘', color: '#9333ea', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'db', title: 'å››ã€å‚µå‹™åŸºé‡‘', color: '#ea580c', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'cp', title: 'äº”ã€è³‡æœ¬è¨ˆç•«åŸºé‡‘', color: '#0891b2', fields: ['name','source','use','surplus','begin','remit','end'] }
    ];

    const fieldNames = { name:'åŸºé‡‘åç¨±', rev:'æ”¶å…¥', cost:'æ”¯å‡º', gross:'æ¯›åˆ©', exp:'è²»ç”¨', opprofit:'åˆ©ç›Š', pretax:'ç¨…å‰', net:'ç›ˆè™§', surplus:'è³¸é¤˜', non:'æ¥­å¤–', source:'ä¾†æº', use:'ç”¨é€”', begin:'æœŸåˆ', remit:'è§£ç¹³', end:'æœŸæœ«' };

    // --- Tab åˆ‡æ› ---
    function switchTab(tabId) {
        document.getElementById('tab-manager').classList.toggle('hidden', tabId !== 'manager');
        document.getElementById('tab-aggregator').classList.toggle('hidden', tabId !== 'aggregator');
        document.getElementById('btn-manager').classList.toggle('bg-white', tabId === 'manager');
        document.getElementById('btn-aggregator').classList.toggle('bg-white', tabId === 'aggregator');
    }

    // --- å¡«å ±ç«™é‚è¼¯ ---
    function renderManager() {
        const container = document.getElementById('sections-container');
        sectionConfigs.forEach(conf => {
            const div = document.createElement('div');
            div.className = 'bg-white p-6 rounded-lg shadow-sm border-l-4';
            div.style.borderLeftColor = conf.color;
            div.innerHTML = `
                <div class="flex justify-between mb-4"><h3 class="font-bold text-lg" style="color:${conf.color}">${conf.title}</h3><button onclick="mgr_addRow('${conf.id}')" class="bg-slate-100 px-3 py-1 rounded-full text-xs font-bold hover:bg-slate-200">+ æ–°å¢åˆ—</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table">
                    <thead><tr><th class="w-8"></th>${conf.fields.map(f => `<th>${fieldNames[f]}</th>`).join('')}</tr></thead>
                    <tbody id="tbody-${conf.id}"></tbody>
                    <tfoot id="tfoot-${conf.id}" class="total-row">
                        <tr><td>âˆ‘</td><td class="text-center font-bold">å°è¨ˆ</td>${conf.fields.slice(1).map(f => `<td><input type="text" class="t-${f}" readonly value="0"></td>`).join('')}</tr>
                    </tfoot>
                </table></div>`;
            container.appendChild(div);
            mgr_addRow(conf.id);
        });
    }

    function mgr_addRow(type, data = {}) {
        const conf = sectionConfigs.find(c => c.id === type);
        const tr = document.createElement('tr');
        let html = `<td class="text-center"><button onclick="this.closest('tr').remove(); update('${type}');" class="text-red-400">âœ•</button></td>`;
        conf.fields.forEach(f => {
            const isName = f === 'name';
            const isRO = ['gross','opprofit','pretax','net','surplus','end'].includes(f);
            const tip = isRO ? '' : 'data-input-tip="æ”¯æ´ Excel è²¼ä¸Š"';
            html += `<td><input type="${isName?'text':'number'}" class="v-${f} ${isName?'name-input text-left':''}" value="${data[f]||''}" ${isRO?'readonly':''} oninput="update('${type}')" ${tip}></td>`;
        });
        tr.innerHTML = html;
        document.getElementById(`tbody-${type}`).appendChild(tr);
    }

    function update(type) {
        const rows = document.querySelectorAll(`#tbody-${type} tr`);
        const conf = sectionConfigs.find(c => c.id === type);
        const totals = {}; conf.fields.slice(1).forEach(f => totals[f] = 0);

        rows.forEach(row => {
            const v = (c) => parseFloat(row.querySelector('.v-'+c).value) || 0;
            const r = (c) => row.querySelector('.v-'+c);
            // è¨ˆç®—å…¬å¼
            if(type === 'op') { let g = v('rev')-v('cost'), p = g-v('exp'); r('gross').value = g; r('opprofit').value = p; r('pretax').value = p; r('net').value = p; }
            else if(type === 'wk') { let s = v('rev')-v('cost'); r('surplus').value = s; r('net').value = s + v('non'); }
            else { let s = v('source')-v('use'); r('surplus').value = s; r('end').value = v('begin') + s - v('remit'); }
            // ç´…å­—èˆ‡åˆè¨ˆ
            conf.fields.slice(1).forEach(f => {
                const el = row.querySelector('.v-'+f);
                const val = parseFloat(el.value) || 0;
                el.classList.toggle('negative-value', val < 0);
                totals[f] += val;
            });
        });

        Object.keys(totals).forEach(f => {
            const tEl = document.querySelector(`#tfoot-${type} .t-${f}`);
            tEl.value = totals[f].toLocaleString();
            tEl.classList.toggle('negative-value', totals[f] < 0);
        });
        mgr_autoSave();
    }

    // --- åŒ¯æ•´å„€è¡¨æ¿é‚è¼¯ ---
    let agg_data = [];

    function agg_setupDrag() {
        const zone = document.getElementById('agg-dropzone');
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('active'));
        zone.addEventListener('drop', (e) => { e.preventDefault(); zone.classList.remove('active'); agg_handleFiles(e.dataTransfer.files); });
    }

    function agg_handleFiles(files) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const txt = e.target.result;
                if(file.name.endsWith('.json')) { try { agg_process(JSON.parse(txt)); } catch(err){} }
                else {
                    const doc = new DOMParser().parseFromString(txt, 'text/html');
                    const meta = { org: doc.getElementById('mgr-org')?.value || 'æœªçŸ¥å–®ä½' };
                    const scrape = (id) => Array.from(doc.querySelectorAll(`#tbody-${id} tr`)).map(tr => {
                        let o = { name: tr.querySelector('.v-name')?.value };
                        tr.querySelectorAll('input').forEach(i => o[i.className.replace('v-', '')] = i.value);
                        return o.name ? o : null;
                    }).filter(x=>x);
                    agg_process({ metadata: meta, op: scrape('op'), wk: scrape('wk'), sp: scrape('sp'), db: scrape('db'), cp: scrape('cp') });
                }
            };
            reader.readAsText(file);
        });
    }

    function agg_process(json) {
        const idx = agg_data.findIndex(g => g.metadata.org === json.metadata.org);
        if(idx >= 0) agg_data[idx] = json; else agg_data.push(json);
        agg_updateDashboard();
    }

    function agg_updateDashboard() {
        document.getElementById('agg-content').classList.remove('hidden');
        const sel = document.getElementById('agg-filter-gov');
        sel.innerHTML = '<option value="all">ğŸ¢ æ‰€æœ‰æ©Ÿé—œ</option>';
        agg_data.forEach(g => sel.innerHTML += `<option value="${g.metadata.org}">${g.metadata.org}</option>`);

        let s = { rev: 0, surplus: 0, loss: 0 };
        agg_data.forEach(g => {
            sectionConfigs.forEach(c => g[c.id]?.forEach(f => {
                let i = parseFloat(f.rev || f.source || 0), n = parseFloat(f.net || f.surplus || 0);
                s.rev += i; s.surplus += n; if(n < 0) s.loss++;
            }));
        });
        document.getElementById('kpi-govs').innerText = agg_data.length;
        document.getElementById('kpi-rev').innerText = (s.rev/100000).toFixed(2);
        document.getElementById('kpi-surplus').innerText = (s.surplus/100000).toFixed(2);
        document.getElementById('kpi-loss').innerText = s.loss;
        agg_search();
    }

    function agg_search() {
        const gov = document.getElementById('agg-filter-gov').value, txt = document.getElementById('agg-search-txt').value.toLowerCase(), type = document.getElementById('agg-filter-type').value, tbody = document.getElementById('agg-search-body');
        tbody.innerHTML = '';
        agg_data.forEach(g => {
            if(gov !== 'all' && g.metadata.org !== gov) return;
            sectionConfigs.forEach(c => {
                if(type !== 'all' && type !== c.id) return;
                g[c.id]?.forEach(f => {
                    if(txt && !f.name.toLowerCase().includes(txt)) return;
                    let i = parseFloat(f.rev || f.source || 0), n = parseFloat(f.net || f.surplus || 0);
                    tbody.innerHTML += `<tr><td>${g.metadata.org}</td><td>${c.id.toUpperCase()}</td><td>${f.name}</td><td class="text-right">${i.toLocaleString()}</td><td class="text-right font-bold ${n<0?'text-red-400':'text-green-400'}">${n.toLocaleString()}</td></tr>`;
                });
            });
        });
    }

    // --- å·¥å…·åŠŸèƒ½ ---
    function mgr_exportHTML() {
        document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
        saveAs(new Blob(["<!DOCTYPE html>\n" + document.documentElement.outerHTML], {type: "text/html"}), `${document.getElementById('mgr-org').value}_é ç®—å‚™ä»½.html`);
    }

    function mgr_exportXLSX() {
        const wb = XLSX.utils.book_new();
        sectionConfigs.forEach(conf => {
            const rows = Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`));
            if(rows.length === 0) return;
            const data = rows.map(tr => {
                let o = {}; conf.fields.forEach(f => o[fieldNames[f]] = tr.querySelector('.v-'+f).value);
                return o;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), conf.title.split('ã€')[1]);
        });
        XLSX.writeFile(wb, "æ”¿åºœé ç®—å ±è¡¨.xlsx");
    }

    function mgr_autoSave() { localStorage.setItem('budget_v345', document.getElementById('sections-container').innerHTML); }
    function mgr_clearAll() { if(confirm('æ¸…ç©ºè³‡æ–™ï¼Ÿ')) { localStorage.removeItem('budget_v345'); location.reload(); } }
    function agg_clearAll() { if(confirm('æ¸…ç©ºå·¥ä½œå€ï¼Ÿ')) { agg_data=[]; document.getElementById('agg-content').classList.add('hidden'); } }

    // Excel è²¼ä¸Šæ”¯æ´
    document.addEventListener('paste', e => {
        const el = document.activeElement;
        if (!el || el.tagName !== 'INPUT' || el.readOnly) return;
        const text = e.clipboardData.getData('text');
        if (!text.includes('\t')) return;
        e.preventDefault();
        const rowsData = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        const startTr = el.closest('tr');
        const tbody = startTr.parentNode;
        const type = tbody.id.replace('tbody-', '');
        const startColIdx = Array.from(startTr.children).indexOf(el.closest('td'));
        const startRowIdx = Array.from(tbody.children).indexOf(startTr);
        rowsData.forEach((rowStr, i) => {
            let targetTr = tbody.children[startRowIdx + i];
            if (!targetTr) { mgr_addRow(type); targetTr = tbody.lastElementChild; }
            rowStr.split('\t').forEach((val, j) => {
                const input = targetTr.children[startColIdx + j]?.querySelector('input:not([readonly])');
                if (input) { input.value = val.trim().replace(/,/g, ''); input.dispatchEvent(new Event('input')); }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => { renderManager(); agg_setupDrag(); });
</script>
</body>
</html>
