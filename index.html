<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿åºœé ç®—æ”¶æ”¯å¡«å ±èˆ‡åŒ¯æ•´ç³»çµ± (All-in-One)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        
        /* Tabs Styles */
        .tab-btn { @apply px-6 py-3 font-bold text-gray-500 border-b-4 border-transparent hover:text-blue-500 transition-all; }
        .tab-btn.active { @apply text-blue-600 border-blue-600; }
        
        /* Manager Styles */
        .budget-table th { background-color: #e2e8f0; padding: 8px; font-size: 0.85rem; border: 1px solid #cbd5e1; white-space: nowrap; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 100px; }
        .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
        .budget-table input[readonly] { font-weight: bold; color: #2563eb; background-color: #f8fafc; }
        
        /* Aggregator Styles */
        .drop-zone { border: 3px dashed #475569; transition: all 0.3s; background-color: #1e293b; position: relative; }
        .drop-zone.active { border-color: #38bdf8; background-color: #334155; transform: scale(1.01); }
        .agg-table th { background-color: #334155; color: #94a3b8; padding: 12px; font-size: 0.85rem; text-align: left; }
        .agg-table td { padding: 12px; border-bottom: 1px solid #334155; font-size: 0.9rem; color: #e2e8f0; }
        
        /* Sorting */
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #475569; color: white; }
        th.sortable::after { content: ' â†•'; opacity: 0.3; float: right; }
        th.sortable.asc::after { content: ' â†‘'; opacity: 1; color: #38bdf8; }
        th.sortable.desc::after { content: ' â†“'; opacity: 1; color: #38bdf8; }
    </style>
</head>
<body>

<nav class="bg-white shadow sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center h-16">
            <div class="flex-shrink-0 font-bold text-xl text-slate-700">ğŸ‡¹ğŸ‡¼ æ”¿åºœé ç®—ç³»çµ±</div>
            <div class="flex space-x-1">
                <button onclick="switchTab('guide')" id="btn-guide" class="tab-btn active">ğŸ“– ä½¿ç”¨æŒ‡å—</button>
                <button onclick="switchTab('manager')" id="btn-manager" class="tab-btn">ğŸ“ é ç®—å¡«å ±å·¥ä½œç«™</button>
                <button onclick="switchTab('aggregator')" id="btn-aggregator" class="tab-btn">ğŸ“Š é ç®—åŒ¯æ•´å„€è¡¨æ¿</button>
            </div>
        </div>
    </div>
</nav>

<div id="tab-guide" class="max-w-5xl mx-auto p-8 block">
    <div class="bg-white rounded-2xl shadow-lg p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">æ­¡è¿ä½¿ç”¨é ç®—æ”¶æ”¯å¡«å ±èˆ‡åŒ¯æ•´ç³»çµ±</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            <div class="bg-blue-50 p-8 rounded-xl border border-blue-100">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ğŸ“</span>
                    <h2 class="text-xl font-bold text-blue-800">æˆ‘æ˜¯å¡«å ±å–®ä½</h2>
                </div>
                <p class="text-gray-600 mb-4 font-bold">é©ç”¨å°è±¡ï¼šé„‰é®å¸‚å…¬æ‰€ã€é™„å±¬æ©Ÿé—œã€å„ç‰¹ç¨®åŸºé‡‘å–®ä½ã€‚</p>
                <ul class="list-disc list-inside space-y-2 text-gray-700 text-sm">
                    <li>è«‹é»æ“Šä¸Šæ–¹ <strong>ã€Œé ç®—å¡«å ±å·¥ä½œç«™ã€</strong> é ç±¤ã€‚</li>
                    <li>ä¾åºå¡«å¯«ç‡Ÿæ¥­ã€ä½œæ¥­ã€ç‰¹åˆ¥æ”¶å…¥ç­‰åŸºé‡‘çš„é ç®—æ•¸æ“šã€‚</li>
                    <li>ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—æ¯›åˆ©ã€æ·¨åˆ©èˆ‡è³¸é¤˜ã€‚</li>
                    <li>å®Œæˆå¾Œï¼Œè«‹é»æ“Š <strong>ã€ŒåŒ¯å‡ºå‚™ä»½ (HTML)ã€</strong> æˆ– <strong>ã€ŒåŒ¯å‡º JSONã€</strong>ã€‚</li>
                    <li>å°‡ä¸‹è¼‰çš„æª”æ¡ˆå‚³é€çµ¦ä¸Šç´šåŒ¯æ•´å–®ä½ã€‚</li>
                </ul>
            </div>

            <div class="bg-indigo-50 p-8 rounded-xl border border-indigo-100">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">ğŸ“Š</span>
                    <h2 class="text-xl font-bold text-indigo-800">æˆ‘æ˜¯åŒ¯æ•´å–®ä½</h2>
                </div>
                <p class="text-gray-600 mb-4 font-bold">é©ç”¨å°è±¡ï¼šç¸£å¸‚æ”¿åºœä¸»è¨ˆè™•ã€ç›´è½„å¸‚åºœåŒ¯æ•´äººå“¡ã€‚</p>
                <ul class="list-disc list-inside space-y-2 text-gray-700 text-sm">
                    <li>è«‹é»æ“Šä¸Šæ–¹ <strong>ã€Œé ç®—åŒ¯æ•´å„€è¡¨æ¿ã€</strong> é ç±¤ã€‚</li>
                    <li>æ”¶é›†è½„ä¸‹å„å–®ä½å‚³ä¾†çš„æª”æ¡ˆ (HTML æˆ– JSON çš†å¯)ã€‚</li>
                    <li>å°‡é€™äº›æª”æ¡ˆ <strong>ä¸€æ¬¡æ‹–å…¥</strong> è™›ç·šæ¡†å…§ã€‚</li>
                    <li>ç³»çµ±å°‡è‡ªå‹•åŠ ç¸½ä¸¦ç”¢ç”Ÿåˆ†æå ±è¡¨ã€‚</li>
                    <li>ç¢ºèªç„¡èª¤å¾Œï¼Œé»æ“Š <strong>ã€ŒåŒ¯å‡º Excelã€</strong> ç”¢ç”Ÿæ­£å¼ç¸½è¡¨ã€‚</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-8 text-center text-gray-400 text-sm">
            ç³»çµ±ç‰ˆæœ¬ï¼šv2.0 (æ•´åˆç‰ˆ) | è³‡æ–™è™•ç†ï¼šæœ¬æ©Ÿç«¯é‹ç®— (Local Processing)ï¼Œè³‡æ–™ä¸æœƒä¸Šå‚³é›²ç«¯ï¼Œè«‹å®‰å¿ƒä½¿ç”¨ã€‚
        </div>
    </div>
</div>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 hidden">
    <div class="bg-white p-4 rounded-xl shadow mb-6 flex flex-wrap justify-between items-center gap-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“ å¡«å ±å·¥ä½œç«™</h2>
            <span id="mgr-status" class="text-xs text-gray-500">ğŸŸ¢ è‡ªå‹•å„²å­˜å°±ç·’</span>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('mgr-import').click()" class="bg-gray-100 px-4 py-2 rounded hover:bg-gray-200">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="mgr-import" class="hidden" accept=".json,.html" onchange="mgr_importFile(this)">
            
            <button onclick="mgr_exportJSON()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 shadow">ğŸ’¾ åŒ¯å‡º JSON</button>
            <button onclick="mgr_exportHTML()" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 shadow">ğŸŒ åŒ¯å‡ºå‚™ä»½ (HTML)</button>
            <button onclick="mgr_exportXLSX()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_clearAll()" class="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <div class="grid grid-cols-3 gap-6">
                <div><label class="block text-sm font-bold text-gray-700">å–®ä½åç¨±</label><input type="text" id="mgr-org" class="w-full border-b-2 py-1" placeholder="ä¾‹å¦‚ï¼šæ¿æ©‹å€å…¬æ‰€" oninput="mgr_autoSave()"></div>
                <div><label class="block text-sm font-bold text-gray-700">å¹´åº¦</label><input type="number" id="mgr-year" value="114" class="w-full border-b-2 py-1" oninput="mgr_autoSave()"></div>
                <div><label class="block text-sm font-bold text-gray-700">å¡«è¡¨äºº</label><input type="text" id="mgr-user" class="w-full border-b-2 py-1" oninput="mgr_autoSave()"></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-blue-800">ğŸ¢ ç‡Ÿæ¥­åŸºé‡‘</h3><button onclick="mgr_addOpRow()" class="bg-blue-50 text-blue-600 px-2 rounded text-sm">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>ç‡Ÿæ¥­æ”¶å…¥</th><th>ç‡Ÿæ¥­æˆæœ¬</th><th>ç‡Ÿæ¥­æ¯›åˆ©</th><th>ç‡Ÿæ¥­è²»ç”¨</th><th>ç‡Ÿæ¥­åˆ©ç›Š</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>æ¥­å¤–åˆ©ç›Š</th><th>ç¨…å‰æ·¨åˆ©</th><th>æ‰€å¾—ç¨…</th><th>æœ¬æœŸæ·¨åˆ©</th></tr></thead><tbody id="mgr-tbody-op"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-green-800">ğŸ—ï¸ ä½œæ¥­åŸºé‡‘</h3><button onclick="mgr_addWkRow()" class="bg-green-50 text-green-600 px-2 rounded text-sm">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>æ¥­å‹™æ”¶å…¥</th><th>æˆæœ¬è²»ç”¨</th><th>æ¥­å‹™è³¸é¤˜</th><th>æ¥­å¤–æ”¶å…¥</th><th>æ¥­å¤–è²»ç”¨</th><th>æ¥­å¤–è³¸é¤˜</th><th>æœ¬æœŸè³¸é¤˜</th></tr></thead><tbody id="mgr-tbody-wk"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-purple-800">ğŸ’° ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘</h3><button onclick="mgr_addSpRow()" class="bg-purple-50 text-purple-600 px-2 rounded text-sm">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>è§£ç¹³å…¬åº«</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="mgr-tbody-sp"></tbody></table></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-orange-500">
            <div class="flex justify-between mb-4"><h3 class="font-bold text-orange-800">ğŸ“‰ å‚µå‹™åŸºé‡‘</h3><button onclick="mgr_addDebtRow()" class="bg-orange-50 text-orange-600 px-2 rounded text-sm">+ æ–°å¢</button></div>
            <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th><th>åŸºé‡‘åç¨±</th><th>åŸºé‡‘ä¾†æº</th><th>åŸºé‡‘ç”¨é€”</th><th>æœ¬æœŸè³¸é¤˜</th><th>æœŸåˆç´¯ç©</th><th>æœŸæœ«ç´¯ç©</th></tr></thead><tbody id="mgr-tbody-debt"></tbody></table></div>
        </div>
    </div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-4 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex flex-wrap justify-between items-end mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white">ğŸ“Š åŒ¯æ•´å„€è¡¨æ¿</h1>
            <p class="text-slate-400 text-sm">æ”¯æ´æ‹–æ›³åŒ¯å…¥å¤šå€‹ .json æˆ– .html æª”æ¡ˆ</p>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('agg-input').click()" class="bg-slate-700 px-4 py-2 rounded hover:bg-slate-600 text-sm">ğŸ“‚ åŒ¯å…¥æª”æ¡ˆ</button>
            <input type="file" id="agg-input" multiple accept=".json,.html" class="hidden" onchange="agg_handleFiles(this.files)">
            <button onclick="agg_exportWorkspace()" class="bg-teal-600 px-4 py-2 rounded hover:bg-teal-500 text-sm shadow">ğŸŒ å„²å­˜å·¥ä½œå€</button>
            <button onclick="agg_clearAll()" class="bg-red-900 px-4 py-2 rounded hover:bg-red-800 text-sm border border-red-700">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div id="agg-dropzone" class="drop-zone rounded-xl p-8 text-center cursor-pointer mb-8">
        <p class="text-xl font-bold text-slate-300">è«‹å°‡å„å–®ä½å›å‚³æª”æ¡ˆæ‹–æ›³è‡³æ­¤</p>
        <p class="text-sm text-slate-500">ç³»çµ±å°‡è‡ªå‹•è§£æåˆä½µ</p>
    </div>

    <div id="agg-content" class="hidden space-y-8">
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <div class="stat-card border-l-4 border-blue-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">å–®ä½æ•¸</div><div class="text-2xl font-bold" id="kpi-govs">0</div></div>
            <div class="stat-card border-l-4 border-indigo-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">åŸºé‡‘æ•¸</div><div class="text-2xl font-bold" id="kpi-funds">0</div></div>
            <div class="stat-card border-l-4 border-green-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">ç¸½æ”¶å…¥(å„„)</div><div class="text-2xl font-bold text-green-400" id="kpi-rev">0</div></div>
            <div class="stat-card border-l-4 border-emerald-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">ç¸½è³¸é¤˜(å„„)</div><div class="text-2xl font-bold text-emerald-400" id="kpi-surplus">0</div></div>
            <div class="stat-card border-l-4 border-teal-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">ç›ˆé¤˜å®¶æ•¸</div><div class="text-2xl font-bold text-teal-300" id="kpi-profit">0</div></div>
            <div class="stat-card border-l-4 border-red-500 bg-slate-800 p-4 rounded"><div class="text-slate-400 text-xs">è™§æå®¶æ•¸</div><div class="text-2xl font-bold text-red-400" id="kpi-loss">0</div></div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <select id="agg-filter-gov" class="bg-slate-900 border border-slate-600 rounded p-2 text-white" onchange="agg_search()"><option value="all">ğŸ¢ æ‰€æœ‰å–®ä½</option></select>
                <input type="text" id="agg-search-txt" placeholder="æœå°‹åŸºé‡‘..." class="bg-slate-900 border border-slate-600 rounded p-2 text-white" oninput="agg_search()">
                <select id="agg-filter-type" class="bg-slate-900 border border-slate-600 rounded p-2 text-white" onchange="agg_search()">
                    <option value="all">ğŸ“‚ æ‰€æœ‰é¡å‹</option><option value="op">ç‡Ÿæ¥­åŸºé‡‘</option><option value="wk">ä½œæ¥­åŸºé‡‘</option><option value="sp">ç‰¹æ”¶åŸºé‡‘</option><option value="debt">å‚µå‹™åŸºé‡‘</option>
                </select>
            </div>
            <div class="overflow-x-auto max-h-64 overflow-y-auto border border-slate-700 rounded">
                <table class="w-full agg-table text-left text-sm">
                    <thead class="sticky top-0 bg-slate-900 z-10">
                        <tr>
                            <th class="sortable" onclick="agg_sortSearch('gov')">å–®ä½</th>
                            <th class="sortable" onclick="agg_sortSearch('type')">é¡å‹</th>
                            <th class="sortable" onclick="agg_sortSearch('name')">åç¨±</th>
                            <th class="text-right sortable" onclick="agg_sortSearch('rev')">ç¸½æ”¶å…¥</th>
                            <th class="text-right sortable" onclick="agg_sortSearch('exp')">ç¸½æ”¯å‡º</th>
                            <th class="text-right sortable" onclick="agg_sortSearch('net')">æœ¬æœŸç›ˆè™§</th>
                        </tr>
                    </thead>
                    <tbody id="agg-search-body"></tbody>
                </table>
            </div>
            <div class="text-right text-xs text-slate-500 mt-2" id="agg-search-stats">0 ç­†</div>
        </div>

        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">ğŸ›ï¸ å„å–®ä½åŒ¯æ•´æ¦‚æ³</h3>
                <button onclick="agg_exportExcel()" class="bg-green-600 px-4 py-2 rounded hover:bg-green-500 text-sm font-bold shadow">ğŸ“Š åŒ¯å‡º Excel</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full agg-table text-left text-sm">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="agg_sortGov('org')">å–®ä½åç¨±</th>
                            <th class="sortable" onclick="agg_sortGov('opNet')">ç‡Ÿæ¥­æ·¨åˆ©</th>
                            <th class="sortable" onclick="agg_sortGov('wkNet')">ä½œæ¥­è³¸é¤˜</th>
                            <th class="sortable" onclick="agg_sortGov('spSurplus')">ç‰¹æ”¶è³¸é¤˜</th>
                            <th class="sortable" onclick="agg_sortGov('debtEnd')">å‚µå‹™æœŸæœ«</th>
                            <th class="sortable" onclick="agg_sortGov('totalPerf')">ç¶œåˆè©•ä¼°</th>
                        </tr>
                    </thead>
                    <tbody id="agg-gov-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tabId).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    // ==========================================
    // MODULE: MANAGER (å¡«å ±ç«¯)
    // ==========================================
    
    document.addEventListener('DOMContentLoaded', () => {
        mgr_loadFromStorage();
        if(document.querySelectorAll('#mgr-tbody-op tr').length === 0) mgr_resetRows();
        
        // Auto-load aggregator backup if present in HTML
        if(window.embeddedData && window.embeddedData.length > 0) {
            agg_data = window.embeddedData;
            agg_updateDashboard();
        }
        
        agg_setupDrag();
    });

    function mgr_resetRows() {
        ['op','wk','sp','debt'].forEach(t => document.getElementById(`mgr-tbody-${t}`).innerHTML = '');
        mgr_addOpRow(); mgr_addWkRow(); mgr_addSpRow(); mgr_addDebtRow();
    }

    function mgr_createInput(cls, val='', ro=false, oninp='') {
        return `<input type="${ro?'text':'number'}" class="${cls}" value="${val}" ${ro?'readonly':''} ${oninp?'oninput="'+oninp+'(this)"':''} placeholder="${ro?'':0}">`;
    }

    // Row Adders
    function mgr_addOpRow(d={}) { 
        const tr=document.createElement('tr'); 
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer font-bold" onclick="mgr_delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="mgr_autoSave()"></td><td>${mgr_createInput('v-rev',d.rev,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-cost',d.cost,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-gross',d.gross,1)}</td><td>${mgr_createInput('v-exp',d.exp,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-opprofit',d.opprofit,1)}</td><td>${mgr_createInput('v-nonrev',d.nonrev,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-nonexp',d.nonexp,0,'mgr_calcOp')}</td><td>${mgr_createInput('v-nonprofit',d.nonprofit,1)}</td><td>${mgr_createInput('v-pretax',d.pretax,1)}</td><td>${mgr_createInput('v-tax',d.tax,0,'mgr_calcOp')}</td><td><input class="v-net font-bold text-red-600" value="${d.net||''}" readonly></td>`; 
        document.getElementById('mgr-tbody-op').appendChild(tr); if(d.rev) mgr_calcOp(tr.querySelector('.v-rev')); 
    }
    function mgr_addWkRow(d={}) {
        const tr=document.createElement('tr'); 
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer font-bold" onclick="mgr_delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="mgr_autoSave()"></td><td>${mgr_createInput('v-rev',d.rev,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-cost',d.cost,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-nonrev',d.nonrev,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-nonexp',d.nonexp,0,'mgr_calcWk')}</td><td>${mgr_createInput('v-nonsurplus',d.nonsurplus,1)}</td><td><input class="v-net font-bold text-green-600" value="${d.net||''}" readonly></td>`; 
        document.getElementById('mgr-tbody-wk').appendChild(tr); if(d.rev) mgr_calcWk(tr.querySelector('.v-rev'));
    }
    function mgr_addSpRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer font-bold" onclick="mgr_delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="mgr_autoSave()"></td><td>${mgr_createInput('v-source',d.source,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-use',d.use,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-begin',d.begin,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-remit',d.remit,0,'mgr_calcSp')}</td><td><input class="v-end font-bold" value="${d.end||''}" readonly></td>`;
        document.getElementById('mgr-tbody-sp').appendChild(tr); if(d.source) mgr_calcSp(tr.querySelector('.v-source'));
    }
    function mgr_addDebtRow(d={}) {
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="text-center"><span class="text-red-500 cursor-pointer font-bold" onclick="mgr_delRow(this)">Ã—</span></td><td><input type="text" class="name-input" value="${d.name||''}" oninput="mgr_autoSave()"></td><td>${mgr_createInput('v-source',d.source,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-use',d.use,0,'mgr_calcSp')}</td><td>${mgr_createInput('v-surplus',d.surplus,1)}</td><td>${mgr_createInput('v-begin',d.begin,0,'mgr_calcSp')}</td><td><input class="v-end font-bold" value="${d.end||''}" readonly></td>`;
        document.getElementById('mgr-tbody-debt').appendChild(tr); if(d.source) mgr_calcSp(tr.querySelector('.v-source'));
    }
    
    function mgr_delRow(btn) { if(confirm('åˆªé™¤æ­¤åˆ—ï¼Ÿ')) { btn.closest('tr').remove(); mgr_autoSave(); } }

    // Calc Logic
    const mVal = (r,s) => parseFloat(r.querySelector(s)?.value)||0;
    const mSet = (r,s,v) => { if(r.querySelector(s)) r.querySelector(s).value = v; };
    function mgr_calcOp(e) { const r=e.closest('tr'); const g=mVal(r,'.v-rev')-mVal(r,'.v-cost'), op=g-mVal(r,'.v-exp'), np=mVal(r,'.v-nonrev')-mVal(r,'.v-nonexp'); mSet(r,'.v-gross',g); mSet(r,'.v-opprofit',op); mSet(r,'.v-nonprofit',np); mSet(r,'.v-pretax',op+np); mSet(r,'.v-net',op+np-mVal(r,'.v-tax')); mgr_autoSave(); }
    function mgr_calcWk(e) { const r=e.closest('tr'); const s=mVal(r,'.v-rev')-mVal(r,'.v-cost'), ns=mVal(r,'.v-nonrev')-mVal(r,'.v-nonexp'); mSet(r,'.v-surplus',s); mSet(r,'.v-nonsurplus',ns); mSet(r,'.v-net',s+ns); mgr_autoSave(); }
    function mgr_calcSp(e) { const r=e.closest('tr'); const s=mVal(r,'.v-source')-mVal(r,'.v-use'); mSet(r,'.v-surplus',s); mSet(r,'.v-end',mVal(r,'.v-begin')+s-mVal(r,'.v-remit')); mgr_autoSave(); }

    // IO
    function mgr_collectData() {
        const scrape = (id, fields) => Array.from(document.querySelectorAll(`#${id} tr`)).map(r => { let o={}; fields.forEach(f=>o[f.key]=r.querySelector(f.sel)?.value); return o.name?o:null; }).filter(x=>x);
        return {
             metadata: { org: document.getElementById('mgr-org').value, year: document.getElementById('mgr-year').value, user: document.getElementById('mgr-user').value },
             op: scrape('mgr-tbody-op', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'exp',sel:'.v-exp'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'tax',sel:'.v-tax'},{key:'gross',sel:'.v-gross'},{key:'opprofit',sel:'.v-opprofit'},{key:'nonprofit',sel:'.v-nonprofit'},{key:'pretax',sel:'.v-pretax'},{key:'net',sel:'.v-net'}]),
             wk: scrape('mgr-tbody-wk', [{key:'name',sel:'.name-input'},{key:'rev',sel:'.v-rev'},{key:'cost',sel:'.v-cost'},{key:'nonrev',sel:'.v-nonrev'},{key:'nonexp',sel:'.v-nonexp'},{key:'surplus',sel:'.v-surplus'},{key:'nonsurplus',sel:'.v-nonsurplus'},{key:'net',sel:'.v-net'}]),
             sp: scrape('mgr-tbody-sp', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'remit',sel:'.v-remit'},{key:'surplus',sel:'.v-surplus'},{key:'end',sel:'.v-end'}]),
             debt: scrape('mgr-tbody-debt', [{key:'name',sel:'.name-input'},{key:'source',sel:'.v-source'},{key:'use',sel:'.v-use'},{key:'begin',sel:'.v-begin'},{key:'surplus',sel:'.v-surplus'},{key:'end',sel:'.v-end'}])
        };
    }
    
    function mgr_populate(d) {
        document.getElementById('mgr-org').value = d.metadata.org;
        document.getElementById('mgr-year').value = d.metadata.year;
        document.getElementById('mgr-user').value = d.metadata.user;
        mgr_resetRows();
        d.op?.forEach(i=>mgr_addOpRow(i)); d.wk?.forEach(i=>mgr_addWkRow(i)); d.sp?.forEach(i=>mgr_addSpRow(i)); d.debt?.forEach(i=>mgr_addDebtRow(i));
    }

    function mgr_autoSave() { localStorage.setItem('mgr_draft', JSON.stringify(mgr_collectData())); }
    function mgr_loadFromStorage() { const s=localStorage.getItem('mgr_draft'); if(s) mgr_populate(JSON.parse(s)); }
    function mgr_clearAll() { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { localStorage.removeItem('mgr_draft'); mgr_resetRows(); document.getElementById('mgr-org').value=''; } }
    
    function mgr_exportJSON() { const d=mgr_collectData(); saveAs(new Blob([JSON.stringify(d,null,2)],{type:"application/json"}), `${d.metadata.org}_${d.metadata.year}.json`); }
    
    function mgr_exportHTML() {
        document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value)); // Bake values
        const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML; // Capture entire app state
        saveAs(new Blob([html],{type:"text/html"}), `${document.getElementById('mgr-org').value}_å‚™ä»½.html`);
    }

    function mgr_exportXLSX() {
        const d = mgr_collectData();
        const wb = XLSX.utils.book_new();
        const createSheet = (name, data, headers) => {
            if(!data || data.length===0) return;
            const wsData = [headers];
            data.forEach(item => {
                const vals = Object.values(item); 
                // Note: Object.values relies on collectData key order.
                wsData.push(vals); 
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), name);
        };
        createSheet('ç‡Ÿæ¥­åŸºé‡‘', d.op, ['åç¨±','ç‡Ÿæ”¶','æˆæœ¬','è²»ç”¨','æ¥­å¤–æ”¶','æ¥­å¤–è²»','ç¨…','æ¯›åˆ©','ç‡Ÿåˆ©','æ¥­å¤–åˆ©','ç¨…å‰','æ·¨åˆ©']);
        createSheet('ä½œæ¥­åŸºé‡‘', d.wk, ['åç¨±','æ¥­å‹™æ”¶','æˆæœ¬','æ¥­å¤–æ”¶','æ¥­å¤–è²»','æ¥­å‹™è³¸','æ¥­å¤–è³¸','æœ¬æœŸè³¸']);
        createSheet('ç‰¹æ”¶åŸºé‡‘', d.sp, ['åç¨±','ä¾†æº','ç”¨é€”','æœŸåˆ','è§£ç¹³','è³¸é¤˜','æœŸæœ«']);
        createSheet('å‚µå‹™åŸºé‡‘', d.debt, ['åç¨±','ä¾†æº','ç”¨é€”','æœŸåˆ','è³¸é¤˜','æœŸæœ«']);
        XLSX.writeFile(wb, `${d.metadata.org}_é ç®—è¡¨.xlsx`);
    }

    function mgr_importFile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const txt = e.target.result;
            if(file.name.endsWith('.json')) {
                try { mgr_populate(JSON.parse(txt)); mgr_autoSave(); alert('JSON åŒ¯å…¥æˆåŠŸ'); } catch(e){ alert('JSON æ ¼å¼éŒ¯èª¤'); }
            } else {
                const doc = new DOMParser().parseFromString(txt, 'text/html');
                if(doc.getElementById('mgr-org')) {
                    document.getElementById('mgr-org').value = doc.getElementById('mgr-org').value;
                    document.getElementById('mgr-year').value = doc.getElementById('mgr-year').value;
                    document.getElementById('mgr-user').value = doc.getElementById('mgr-user').value;
                    // Rebuild rows from saved HTML structure
                    // Simplified logic: user HTML backup preserves inputs with value attributes
                    // Here we assume the scraper logic or similar rebuild
                    // Ideally, use scraper logic:
                    const g = (tr, s) => tr.querySelector(s)?.getAttribute('value') || tr.querySelector(s)?.value || '';
                    mgr_resetRows();
                    doc.querySelectorAll('#mgr-tbody-op tr').forEach(tr => mgr_addOpRow({name:g(tr,'.name-input'), rev:g(tr,'.v-rev'), cost:g(tr,'.v-cost'), exp:g(tr,'.v-exp'), nonrev:g(tr,'.v-nonrev'), nonexp:g(tr,'.v-nonexp'), tax:g(tr,'.v-tax')}));
                    doc.querySelectorAll('#mgr-tbody-wk tr').forEach(tr => mgr_addWkRow({name:g(tr,'.name-input'), rev:g(tr,'.v-rev'), cost:g(tr,'.v-cost'), nonrev:g(tr,'.v-nonrev'), nonexp:g(tr,'.v-nonexp')}));
                    doc.querySelectorAll('#mgr-tbody-sp tr').forEach(tr => mgr_addSpRow({name:g(tr,'.name-input'), source:g(tr,'.v-source'), use:g(tr,'.v-use'), begin:g(tr,'.v-begin'), remit:g(tr,'.v-remit')}));
                    doc.querySelectorAll('#mgr-tbody-debt tr').forEach(tr => mgr_addDebtRow({name:g(tr,'.name-input'), source:g(tr,'.v-source'), use:g(tr,'.v-use'), begin:g(tr,'.v-begin')}));
                    mgr_autoSave(); alert('HTML å‚™ä»½å·²åŒ¯å…¥');
                } else { alert('ç„¡æ•ˆçš„å‚™ä»½æª”'); }
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    // ==========================================
    // MODULE: AGGREGATOR (åŒ¯æ•´ç«¯)
    // ==========================================
    
    let agg_data = [];
    let agg_searchCache = [];
    let agg_sort = { key: 'net', dir: 'desc' };
    let agg_govSort = { key: 'org', dir: 'desc' };

    function agg_setupDrag() {
        const zone = document.getElementById('agg-dropzone');
        ['dragenter','dragover','dragleave','drop'].forEach(e => {
            zone.addEventListener(e, (ev)=>{ev.preventDefault();ev.stopPropagation();}, false);
            document.body.addEventListener(e, (ev)=>{ev.preventDefault();ev.stopPropagation();}, false);
        });
        ['dragenter','dragover'].forEach(e => zone.addEventListener(e, ()=>zone.classList.add('active'), false));
        ['dragleave','drop'].forEach(e => zone.addEventListener(e, ()=>zone.classList.remove('active'), false));
        zone.addEventListener('drop', (e) => agg_handleFiles(e.dataTransfer.files), false);
        zone.addEventListener('click', ()=>document.getElementById('agg-input').click());
    }

    function agg_handleFiles(files) {
        Array.from(files).forEach(file => {
            const r = new FileReader();
            r.onload = (e) => {
                const txt = e.target.result;
                if(file.name.endsWith('.json')) {
                    try { const j=JSON.parse(txt); if(j.metadata) agg_process(j); } catch(e){}
                } else {
                    // Try Workspace
                    const m = txt.match(/window\.embeddedData = (\[.*?\]);/s);
                    if(m && m[1]) { try{ JSON.parse(m[1]).forEach(j=>agg_process(j)); return; }catch(e){} }
                    // Try County Backup
                    const doc = new DOMParser().parseFromString(txt, 'text/html');
                    if(doc.getElementById('mgr-org')) {
                        // Use scraper from Manager module, but targeting the doc
                        const val = (row,s) => row.querySelector(s)?.getAttribute('value') || row.querySelector(s)?.value || '';
                        const meta = { org: val(doc, '#mgr-org'), year: val(doc, '#mgr-year'), user: val(doc, '#mgr-user') };
                        if(meta.org) {
                            const scrape = (id, fields) => Array.from(doc.querySelectorAll(`#${id} tr`)).map(tr => {
                                let o={}; fields.forEach(k => o[k] = val(tr, `.v-${k}`) || val(tr, `.${k}-input`)); o.name = val(tr, '.name-input'); return o;
                            }).filter(x=>x.name);
                            const op = scrape('mgr-tbody-op', ['rev','cost','exp','nonrev','nonexp','tax','net']);
                            const wk = scrape('mgr-tbody-wk', ['rev','cost','nonrev','nonexp','net']);
                            const sp = scrape('mgr-tbody-sp', ['source','use','surplus']);
                            const debt = scrape('mgr-tbody-debt', ['source','use','surplus']);
                            agg_process({metadata:meta, op, wk, sp, debt});
                        }
                    }
                }
            };
            r.readAsText(file);
        });
        document.getElementById('agg-input').value = '';
    }

    function agg_process(json) {
        const idx = agg_data.findIndex(g => g.metadata.org === json.metadata.org);
        if(idx >= 0) agg_data[idx] = json; else agg_data.push(json);
        agg_updateDashboard();
    }

    function agg_updateDashboard() {
        if(agg_data.length === 0) return;
        document.getElementById('agg-content').classList.remove('hidden');
        
        // Refresh Dropdown
        const sel = document.getElementById('agg-filter-gov');
        sel.innerHTML = '<option value="all">ğŸ¢ æ‰€æœ‰å–®ä½</option>';
        [...agg_data].sort((a,b)=>a.metadata.org.localeCompare(b.metadata.org,'zh-Hant')).forEach(g => {
            sel.innerHTML += `<option value="${g.metadata.org}">${g.metadata.org}</option>`;
        });

        // Calc Stats
        let s = { govs: agg_data.length, funds: 0, rev: 0, surplus: 0, profit: 0, loss: 0 };
        const num = (v) => parseFloat(v)||0;
        
        const getT = (f, t) => {
            let i=0,o=0,n=0;
            if(t==='op') { i=num(f.rev)+num(f.nonrev); n=num(f.net); }
            else if(t==='wk') { i=num(f.rev)+num(f.nonrev); n=num(f.net); }
            else { i=num(f.source); n=num(f.surplus); }
            return {i,n};
        }

        agg_data.forEach(g => {
            ['op','wk','sp','debt'].forEach(t => {
                if(!g[t]) return;
                g[t].forEach(f => {
                    const r = getT(f,t);
                    s.funds++; s.rev += r.i; s.surplus += r.n;
                    if(r.n >= 0) s.profit++; else s.loss++;
                });
            });
        });

        document.getElementById('kpi-govs').innerText = s.govs;
        document.getElementById('kpi-funds').innerText = s.funds;
        document.getElementById('kpi-rev').innerText = (s.rev/100000).toFixed(2);
        document.getElementById('kpi-surplus').innerText = (s.surplus/100000).toFixed(2);
        document.getElementById('kpi-profit').innerText = s.profit;
        document.getElementById('kpi-loss').innerText = s.loss;

        agg_renderGov();
        agg_search();
    }

    function agg_search() {
        const gov = document.getElementById('agg-filter-gov').value;
        const txt = document.getElementById('agg-search-txt').value.toLowerCase();
        const type = document.getElementById('agg-filter-type').value;
        const num = (v) => parseFloat(v)||0;
        
        agg_searchCache = [];
        agg_data.forEach(g => {
            if(gov !== 'all' && g.metadata.org !== gov) return;
            const proc = (list, tCode, tName) => {
                if(type !== 'all' && type !== tCode) return;
                list?.forEach(f => {
                    if(txt && !f.name.toLowerCase().includes(txt)) return;
                    // Total Calc
                    let i=0, o=0, n=0;
                    if(tCode==='op') { i=num(f.rev)+num(f.nonrev); o=num(f.cost)+num(f.exp)+num(f.nonexp)+num(f.tax); n=num(f.net); }
                    else if(tCode==='wk') { i=num(f.rev)+num(f.nonrev); o=num(f.cost)+num(f.nonexp); n=num(f.net); }
                    else { i=num(f.source); o=num(f.use); n=num(f.surplus); }
                    agg_searchCache.push({ gov: g.metadata.org, type: tName, name: f.name, rev: i, exp: o, net: n });
                });
            };
            proc(g.op,'op','ç‡Ÿæ¥­'); proc(g.wk,'wk','ä½œæ¥­'); proc(g.sp,'sp','ç‰¹æ”¶'); proc(g.debt,'debt','å‚µå‹™');
        });
        
        agg_renderSearch();
    }

    function agg_renderSearch() {
        const tbody = document.getElementById('agg-search-body'); tbody.innerHTML = '';
        const k = agg_sort.key, d = agg_sort.dir === 'asc' ? 1 : -1;
        agg_searchCache.sort((a,b) => {
            if(['gov','type','name'].includes(k)) return a[k].localeCompare(b[k],'zh-Hant')*d;
            return (a[k]-b[k])*d;
        });
        
        // Update icons
        document.querySelectorAll('.agg-table th.sortable').forEach(th => {
            th.classList.remove('asc','desc');
            if(th.getAttribute('onclick').includes(`'${k}'`)) th.classList.add(agg_sort.dir);
        });

        agg_searchCache.forEach(r => {
            const color = r.net >= 0 ? 'text-green-400' : 'text-red-400';
            tbody.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-700/50">
                <td>${r.gov}</td><td><span class="bg-slate-600 px-1 rounded text-xs">${r.type}</span></td><td>${r.name}</td>
                <td class="text-right font-mono">${r.rev.toLocaleString()}</td><td class="text-right font-mono">${r.exp.toLocaleString()}</td>
                <td class="text-right font-mono font-bold ${color}">${r.net.toLocaleString()}</td>
            </tr>`;
        });
        document.getElementById('agg-search-stats').innerText = `${agg_searchCache.length} ç­†`;
    }

    function agg_renderGov() {
        const tbody = document.getElementById('agg-gov-body'); tbody.innerHTML = '';
        const num = (v) => parseFloat(v)||0;
        const sum = (arr,k) => arr?arr.reduce((a,i)=>a+num(i[k]),0):0;
        
        let rows = agg_data.map(g => ({
            org: g.metadata.org,
            opNet: sum(g.op,'net'), wkNet: sum(g.wk,'net'), spSurplus: sum(g.sp,'surplus'), debtEnd: sum(g.debt,'end'),
            totalPerf: sum(g.op,'net')+sum(g.wk,'net')+sum(g.sp,'surplus')
        }));

        const k = agg_govSort.key, d = agg_govSort.dir === 'asc' ? 1 : -1;
        rows.sort((a,b) => (k==='org' ? a.org.localeCompare(b.org,'zh-Hant') : a[k]-b[k])*d);

        rows.forEach(r => {
            tbody.innerHTML += `<tr>
                <td class="font-bold text-white">${r.org}</td>
                <td class="${r.opNet>=0?'text-green-300':'text-red-300'}">${r.opNet.toLocaleString()}</td>
                <td class="${r.wkNet>=0?'text-green-300':'text-red-300'}">${r.wkNet.toLocaleString()}</td>
                <td class="${r.spSurplus>=0?'text-green-300':'text-red-300'}">${r.spSurplus.toLocaleString()}</td>
                <td class="text-orange-300">${r.debtEnd.toLocaleString()}</td>
                <td class="${r.totalPerf>=0?'text-green-400':'text-red-400'} font-bold">${r.totalPerf>=0?'ğŸ“ˆ ç›ˆé¤˜':'ğŸ“‰ çŸ­çµ€'}</td>
            </tr>`;
        });
    }

    function agg_sortSearch(k) { agg_sort.dir = (agg_sort.key===k && agg_sort.dir==='desc') ? 'asc':'desc'; agg_sort.key=k; agg_renderSearch(); }
    function agg_sortGov(k) { agg_govSort.dir = (agg_govSort.key===k && agg_govSort.dir==='desc') ? 'asc':'desc'; agg_govSort.key=k; agg_renderGov(); }

    function agg_clearAll() {
        if(!confirm('æ¸…ç©ºå·¥ä½œå€ï¼Ÿ')) return;
        agg_data = []; window.embeddedData = [];
        document.getElementById('agg-content').classList.add('hidden');
    }

    function agg_exportWorkspace() {
        const s = `<script>window.embeddedData = ${JSON.stringify(agg_data)};<\/script>`;
        let h = document.documentElement.outerHTML.replace(/<script>window\.embeddedData = .*?<\/script>/s, '');
        saveAs(new Blob([h.replace('</body>', s+'</body>')], {type:"text/html"}), `åŒ¯æ•´å·¥ä½œå€_${new Date().toISOString().slice(0,10)}.html`);
    }

    function agg_exportExcel() {
        const wb = XLSX.utils.book_new();
        // 1. Comparison
        const ws1Data = [['å–®ä½','ç‡Ÿæ¥­æ·¨åˆ©','ä½œæ¥­è³¸é¤˜','ç‰¹æ”¶è³¸é¤˜','å‚µå‹™æœŸæœ«','ç¶œåˆè©•ä¼°']];
        const num = (v) => parseFloat(v)||0;
        const sum = (arr,k) => arr?arr.reduce((a,i)=>a+num(i[k]),0):0;
        agg_data.forEach(g => {
            const op=sum(g.op,'net'), wk=sum(g.wk,'net'), sp=sum(g.sp,'surplus'), db=sum(g.debt,'end');
            ws1Data.push([g.metadata.org, op, wk, sp, db, op+wk+sp]);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws1Data), "å–®ä½æ¯”è¼ƒè¡¨");

        // 2. Details
        const ws2Data = [['å–®ä½','é¡å‹','åŸºé‡‘åç¨±','ç¸½æ”¶å…¥/ä¾†æº','ç¸½æ”¯å‡º/ç”¨é€”','ç›ˆè™§']];
        agg_data.forEach(g => {
            const push = (list, tName, tCode) => {
                list?.forEach(f => {
                    let i=0, o=0, n=0;
                    if(tCode==='op') { i=num(f.rev)+num(f.nonrev); o=num(f.cost)+num(f.exp)+num(f.nonexp)+num(f.tax); n=num(f.net); }
                    else if(tCode==='wk') { i=num(f.rev)+num(f.nonrev); o=num(f.cost)+num(f.nonexp); n=num(f.net); }
                    else { i=num(f.source); o=num(f.use); n=num(f.surplus); }
                    ws2Data.push([g.metadata.org, tName, f.name, i, o, n]);
                });
            };
            push(g.op,'ç‡Ÿæ¥­','op'); push(g.wk,'ä½œæ¥­','wk'); push(g.sp,'ç‰¹æ”¶','sp'); push(g.debt,'å‚µå‹™','debt');
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws2Data), "æ˜ç´°ç¸½è¡¨");
        
        XLSX.writeFile(wb, `é ç®—åŒ¯æ•´ç¸½è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
</script>

</body>
</html>
