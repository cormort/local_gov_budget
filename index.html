<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self';">
    <title>æ”¿åºœé ç®—æŸ¥å¡«åŒ¯ç¸½ç³»çµ± v3.9.0 (å„ªåŒ–ç‰ˆ)</title>
    <!-- å„ªåŒ–: ä½¿ç”¨å›ºå®šç‰ˆæœ¬ Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .budget-table th { background-color: #e2e8f0; padding: 10px 8px; font-size: 0.8rem; border: 1px solid #cbd5e1; white-space: nowrap; color: #334155; }
        .budget-table td { padding: 4px; border: 1px solid #cbd5e1; min-width: 100px; position: relative; }
        .budget-table input { width: 100%; padding: 4px; border: 1px solid transparent; text-align: right; background: transparent; font-size: 0.9rem; }
        .budget-table input:focus { outline: none; border-color: #3b82f6; background: white; }
        .budget-table input[readonly] { font-weight: bold; background-color: #f8fafc; color: #2563eb; }
        .negative-value { color: #dc2626 !important; font-weight: bold; }
        .total-row { background-color: #f1f5f9; font-weight: bold; }
        .section-card { background: white; padding: 24px; border-radius: 12px; margin-bottom: 2rem; border-top: 4px solid #64748b; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        /* è²¼ä¸ŠåŠŸèƒ½æç¤ºæ¨£å¼ */
        [data-tip]:hover::after {
            content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;
            white-space: nowrap; z-index: 50; pointer-events: none; margin-bottom: 5px;
        }
        .excel-guide { background: #eff6ff; border: 1px dashed #3b82f6; padding: 10px; border-radius: 8px; font-size: 0.85rem; color: #1e40af; margin-bottom: 1rem; }
        
        /* åŒ¯æ•´ç«¯æ‹–æ›³å€æ¨£å¼ */
        .drop-zone { border: 2px dashed #475569; background: #1e293b; transition: all 0.3s; }
        .drop-zone.dragover { border-color: #3b82f6; background: #1e3a5f; }
        
        /* è‡ªå‹•å„²å­˜æç¤º */
        .autosave-indicator { 
            position: fixed; bottom: 20px; right: 20px; 
            background: #22c55e; color: white; padding: 8px 16px; 
            border-radius: 8px; font-size: 0.85rem; opacity: 0; 
            transition: opacity 0.3s; z-index: 100;
        }
        .autosave-indicator.show { opacity: 1; }
        
        /* Undo æŒ‰éˆ• */
        .undo-btn { 
            position: fixed; bottom: 20px; left: 20px; 
            background: #64748b; color: white; padding: 10px 16px; 
            border-radius: 8px; font-size: 0.85rem; cursor: pointer;
            display: none; z-index: 100; border: none;
        }
        .undo-btn:hover { background: #475569; }
        .undo-btn.show { display: block; }
        
        /* KPI å¡ç‰‡ */
        .kpi-card { background: linear-gradient(135deg, #1e293b, #334155); padding: 20px; border-radius: 12px; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>

<nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl">ğŸ‡¹ğŸ‡¼</div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">æ”¿åºœé ç®—æŸ¥å¡«åŒ¯ç¸½å¹³è‡º</h1>
                <p class="text-xs text-slate-500">v3.9.0 (è‡ªå‹•å„²å­˜ + Undo)</p>
            </div>
        </div>
        <div class="tab-pill-container bg-slate-100 p-1 rounded-full flex gap-1">
            <button onclick="switchTab('manager')" id="btn-manager" class="px-6 py-2 rounded-full font-bold transition active bg-white shadow-sm">ğŸ“ å¡«å ±ç«™</button>
            <button onclick="switchTab('aggregator')" id="btn-aggregator" class="px-6 py-2 rounded-full font-bold transition text-slate-500">ğŸ“Š åŒ¯æ•´ç«¯</button>
        </div>
    </div>
</nav>

<div id="tab-manager" class="max-w-[98%] mx-auto p-4 block">
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
            <h2 class="text-2xl font-bold text-slate-800">é ç®—å¡«å ±å·¥ä½œç«™</h2>
            <span class="animate-pulse bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold border border-blue-200">âœ¨ æ”¯æ´ Excel è²¼ä¸Š</span>
            <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold border border-green-200">ğŸ’¾ è‡ªå‹•å„²å­˜</span>
        </div>
        <div class="flex gap-2">
            <button onclick="document.getElementById('mgr-import-file').click()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold border hover:bg-slate-200">ğŸ“‚ åŒ¯å…¥èˆŠæª”</button>
            <input type="file" id="mgr-import-file" class="hidden" accept=".json,.html" onchange="mgr_handleImport(this.files)">
            <button onclick="mgr_exportJSON()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-blue-700">ğŸ’¾ åŒ¯å‡º JSON</button>
            <button onclick="mgr_exportHTML()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">ğŸŒ å‚™ä»½ HTML</button>
            <button onclick="mgr_exportXLSX()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-green-700">ğŸ“Š åŒ¯å‡º Excel</button>
            <button onclick="mgr_clearAll()" class="text-red-500 px-3 py-2 border rounded-lg text-sm hover:bg-red-50">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
    </div>

    <div class="excel-guide flex items-center gap-2">
        <span>ğŸ’¡</span>
        <span><b>æ“ä½œæç¤ºï¼š</b>æ‚¨å¯ä»¥å¾ Excel é¸å–æ•´å¡Šè³‡æ–™å€åŸŸæŒ‰ä¸‹ <kbd class="bg-white px-1 border rounded">Ctrl+C</kbd>ï¼Œé»æ“Šä¸‹æ–¹è¡¨å–®ä»»ä¸€æ ¼å­æŒ‰ä¸‹ <kbd class="bg-white px-1 border rounded">Ctrl+V</kbd> å³å¯å¿«é€Ÿå¡«å…¥å¤šåˆ—æ•¸æ“šã€‚æŒ‰ <kbd class="bg-white px-1 border rounded">Tab</kbd> è·³è‡³ä¸‹ä¸€æ ¼ï¼Œ<kbd class="bg-white px-1 border rounded">Enter</kbd> è·³è‡³ä¸‹ä¸€åˆ—ã€‚</span>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        <div><label class="text-xs font-bold text-slate-400 uppercase">æ©Ÿé—œåç¨±</label><input type="text" id="mgr-org" class="border-b-2 w-full p-2 outline-none font-bold focus:border-blue-500"></div>
        <div><label class="text-xs font-bold text-slate-400 uppercase">å¹´åº¦</label><input type="number" id="mgr-year" class="border-b-2 w-full p-2 outline-none" value="115"></div>
        <div><label class="text-xs font-bold text-slate-400 uppercase">å¡«è¡¨äºº</label><input type="text" id="mgr-user" class="border-b-2 w-full p-2 outline-none" placeholder="å§“å"></div>
    </div>
    <div id="sections-container"></div>
</div>

<div id="tab-aggregator" class="max-w-[98%] mx-auto p-6 hidden bg-[#0f172a] min-h-screen text-white rounded-xl mt-4">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">ğŸ“Š åŒ¯æ•´ç«¯</h2>
        <button onclick="agg_clearAll()" class="text-red-400 px-4 py-2 border border-red-400 rounded-lg text-sm hover:bg-red-900/30">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
    </div>
    <div id="agg-dropzone" class="drop-zone p-12 text-center cursor-pointer mb-8 rounded-xl">ğŸ“¥ æ‹–æ›³ JSON æˆ– HTML è‡³æ­¤åŒ¯æ•´</div>
    <div id="agg-content" class="hidden space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="agg-kpi"></div>
        <div id="agg-list-area" class="bg-slate-800 p-6 rounded-xl border border-slate-700"><table class="w-full text-left text-sm"><tbody id="agg-list-body"></tbody></table></div>
    </div>
</div>

<!-- è‡ªå‹•å„²å­˜æç¤º -->
<div id="autosave-indicator" class="autosave-indicator">âœ“ å·²è‡ªå‹•å„²å­˜</div>

<!-- Undo æŒ‰éˆ• -->
<button id="undo-btn" class="undo-btn" onclick="undo()">â†© å¾©åŸ (Ctrl+Z)</button>

<script>
    // ========== é…ç½® ==========
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    const sectionConfigs = [
        { id: 'op', title: 'ä¸€ã€ç‡Ÿæ¥­åŸºé‡‘', color: '#2563eb', fields: ['name','rev','cost','gross','exp','opprofit','nonrev','nonexp','nonprofit','pretax','tax','net'] },
        { id: 'wk', title: 'äºŒã€ä½œæ¥­åŸºé‡‘', color: '#16a34a', fields: ['name','rev','cost','surplus','nonrev','nonexp','nonsurplus','net'] },
        { id: 'db', title: 'ä¸‰ã€å‚µå‹™åŸºé‡‘', color: '#ea580c', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'sp', title: 'å››ã€ç‰¹åˆ¥æ”¶å…¥åŸºé‡‘', color: '#9333ea', fields: ['name','source','use','surplus','begin','remit','end'] },
        { id: 'cp', title: 'äº”ã€è³‡æœ¬è¨ˆç•«åŸºé‡‘', color: '#0891b2', fields: ['name','source','use','surplus','begin','remit','end'] }
    ];

    const fieldNames = { name:'åŸºé‡‘åç¨±', rev:'æ”¶å…¥', cost:'æˆæœ¬è²»ç”¨', gross:'æ¯›åˆ©', exp:'è²»ç”¨', opprofit:'åˆ©ç›Š', nonrev:'å¤–æ”¶å…¥', nonexp:'å¤–è²»ç”¨', nonprofit:'å¤–åˆ©ç›Š', pretax:'ç¨…å‰', tax:'æ‰€å¾—ç¨…', net:'æœ¬æœŸç›ˆè™§', surplus:'æœ¬æœŸè³¸é¤˜', nonsurplus:'å¤–è³¸é¤˜', source:'ä¾†æº', use:'ç”¨é€”', begin:'æœŸåˆ', remit:'è§£ç¹³', end:'æœŸæœ«' };

    // ========== Undo ç³»çµ± ==========
    const undoStack = [];
    const MAX_UNDO = 50;

    function saveState() {
        const state = collectData();
        undoStack.push(JSON.stringify(state));
        if (undoStack.length > MAX_UNDO) undoStack.shift();
        document.getElementById('undo-btn').classList.toggle('show', undoStack.length > 1);
    }

    function undo() {
        if (undoStack.length <= 1) return;
        undoStack.pop(); // ç§»é™¤ç•¶å‰ç‹€æ…‹
        const prevState = undoStack[undoStack.length - 1];
        if (prevState) {
            mgr_populate(JSON.parse(prevState), false); // ä¸å† push åˆ° undo stack
            showAutosave('â†© å·²å¾©åŸ');
        }
        document.getElementById('undo-btn').classList.toggle('show', undoStack.length > 1);
    }

    // Ctrl+Z å…¨åŸŸå¿«æ·éµ
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            const el = document.activeElement;
            // åªåœ¨éè¼¸å…¥æ¡†æ™‚è§¸ç™¼å…¨åŸŸ undo
            if (!el || el.tagName !== 'INPUT' && el.tagName !== 'TEXTAREA') {
                e.preventDefault();
                undo();
            }
        }
    });

    // ========== Debounce å·¥å…· ==========
    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ========== localStorage è‡ªå‹•å„²å­˜ ==========
    const STORAGE_KEY = 'budget_data_v3';

    function collectData() {
        return {
            metadata: { 
                org: document.getElementById('mgr-org').value, 
                year: document.getElementById('mgr-year').value, 
                user: document.getElementById('mgr-user').value,
                savedAt: new Date().toISOString()
            },
            sections: sectionConfigs.map(conf => ({ 
                id: conf.id, 
                items: Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`)).map(tr => {
                    let item = {}; 
                    conf.fields.forEach(f => item[f] = tr.querySelector('.v-'+f)?.value || ''); 
                    return item;
                })
            }))
        };
    }

    function saveToStorage() {
        try {
            const data = collectData();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            showAutosave();
        } catch (e) {
            console.error('å„²å­˜å¤±æ•—:', e);
        }
    }

    function loadFromStorage() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                mgr_populate(data, false);
                return true;
            }
        } catch (e) {
            console.error('è¼‰å…¥å¤±æ•—:', e);
        }
        return false;
    }

    function showAutosave(msg = 'âœ“ å·²è‡ªå‹•å„²å­˜') {
        const indicator = document.getElementById('autosave-indicator');
        indicator.textContent = msg;
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 1500);
    }

    // Debounced ç‰ˆæœ¬çš„å„²å­˜
    const debouncedSave = debounce(() => {
        saveState();
        saveToStorage();
    }, 500);

    // ========== æ ¸å¿ƒåŠŸèƒ½ ==========
    function switchTab(id) {
        document.getElementById('tab-manager').classList.toggle('hidden', id !== 'manager');
        document.getElementById('tab-aggregator').classList.toggle('hidden', id !== 'aggregator');
        document.getElementById('btn-manager').className = `px-6 py-2 rounded-full font-bold transition ${id === 'manager' ? 'bg-white shadow-sm' : 'text-slate-500'}`;
        document.getElementById('btn-aggregator').className = `px-6 py-2 rounded-full font-bold transition ${id === 'aggregator' ? 'bg-white shadow-sm' : 'text-slate-500'}`;
    }

    function render() {
        const container = document.getElementById('sections-container');
        container.innerHTML = '';
        sectionConfigs.forEach(conf => {
            const div = document.createElement('div');
            div.className = 'section-card'; div.style.borderTopColor = conf.color;
            div.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg" style="color:${conf.color}">${conf.title}</h3><button onclick="mgr_addRow('${conf.id}')" class="text-blue-600 text-xs font-bold hover:underline">+ æ‰‹å‹•æ–°å¢</button></div>
                <div class="overflow-x-auto"><table class="w-full budget-table"><thead><tr><th class="w-8"></th>${conf.fields.map(f => `<th>${fieldNames[f]}</th>`).join('')}</tr></thead><tbody id="tbody-${conf.id}"></tbody><tfoot id="tfoot-${conf.id}" class="total-row"><tr><td>âˆ‘</td><td class="text-center">åˆè¨ˆ</td>${conf.fields.slice(1).map(f => `<td><input type="text" class="t-${f}" readonly value="0"></td>`).join('')}</tr></tfoot></table></div>`;
            container.appendChild(div);
        });
    }

    function mgr_addRow(type, data = {}) {
        const conf = sectionConfigs.find(c => c.id === type);
        if (!conf) return;
        const tr = document.createElement('tr');
        // Fix: Use JSON.stringify for safe JS string escaping inside event handlers, then escapeHtml for HTML attribute
        const safeType = escapeHtml(JSON.stringify(type));
        tr.innerHTML = `<td class="text-center"><button onclick="deleteRow(this, ${safeType})" class="text-red-400 hover:text-red-600">âœ•</button></td>` + 
            conf.fields.map(f => {
                const isRO = ['gross','opprofit','nonprofit','pretax','net','surplus','nonsurplus','end'].includes(f);
                return `<td data-tip="${isRO?'ç³»çµ±è‡ªå‹•è¨ˆç®—':'æ”¯æ´å¾ Excel è²¼ä¸Šæ•¸æ“š'}"><input type="${f==='name'?'text':'number'}" class="v-${f} ${f==='name'?'text-left':''}" value="${escapeHtml(data[f])}" ${isRO?'readonly':''} oninput="handleInput(${safeType})"></td>`;
            }).join('');
        document.getElementById(`tbody-${type}`).appendChild(tr);
    }

    function deleteRow(btn, type) {
        saveState(); // åˆªé™¤å‰å…ˆå„²å­˜ç‹€æ…‹ä»¥ä¾¿ undo
        btn.closest('tr').remove();
        update(type);
        debouncedSave();
    }

    function handleInput(type) {
        update(type);
        debouncedSave();
    }

    function update(type) {
        const rows = document.querySelectorAll(`#tbody-${type} tr`);
        const conf = sectionConfigs.find(c => c.id === type);
        if (!conf) return;
        let totals = {}; conf.fields.slice(1).forEach(f => totals[f] = 0);
        rows.forEach(row => {
            const v = (c) => parseFloat(row.querySelector('.v-'+c)?.value) || 0;
            const r = (c) => row.querySelector('.v-'+c);
            if(type === 'op') { 
                let g=v('rev')-v('cost'), op=g-v('exp'), np=v('nonrev')-v('nonexp'); 
                if(r('gross')) r('gross').value=g; 
                if(r('opprofit')) r('opprofit').value=op; 
                if(r('nonprofit')) r('nonprofit').value=np; 
                if(r('pretax')) r('pretax').value=op+np; 
                if(r('net')) r('net').value=op+np-v('tax'); 
            }
            else if(type === 'wk') { 
                let s=v('rev')-v('cost'), ns=v('nonrev')-v('nonexp'); 
                if(r('surplus')) r('surplus').value=s; 
                if(r('nonsurplus')) r('nonsurplus').value=ns; 
                if(r('net')) r('net').value=s+ns; 
            }
            else { 
                let s=v('source')-v('use'); 
                if(r('surplus')) r('surplus').value=s; 
                if(r('end')) r('end').value=v('begin')+s-v('remit'); 
            }
            conf.fields.slice(1).forEach(f => { 
                let val=v(f); 
                const el = row.querySelector('.v-'+f);
                if(el) el.classList.toggle('negative-value', val<0); 
                totals[f]+=val; 
            });
        });
        Object.keys(totals).forEach(f => {
            const tEl = document.querySelector(`#tfoot-${type} .t-${f}`);
            if(tEl) { tEl.value = totals[f].toLocaleString(); tEl.classList.toggle('negative-value', totals[f]<0); }
        });
    }

    // ========== éµç›¤å°èˆª ==========
    document.addEventListener('keydown', e => {
        const el = document.activeElement;
        if (!el || el.tagName !== 'INPUT' || el.readOnly) return;
        
        const td = el.closest('td');
        const tr = el.closest('tr');
        const tbody = tr?.parentNode;
        if (!td || !tr || !tbody || !tbody.id?.startsWith('tbody-')) return;
        
        const type = tbody.id.replace('tbody-', '');
        const cells = Array.from(tr.querySelectorAll('td'));
        const colIdx = cells.indexOf(td);
        const rows = Array.from(tbody.children);
        const rowIdx = rows.indexOf(tr);
        
        if (e.key === 'Enter') {
            e.preventDefault();
            // è·³åˆ°ä¸‹ä¸€åˆ—åŒä¸€æ¬„
            let nextRow = rows[rowIdx + 1];
            if (!nextRow) {
                mgr_addRow(type);
                nextRow = tbody.lastElementChild;
            }
            const nextInput = nextRow?.children[colIdx]?.querySelector('input:not([readonly])');
            if (nextInput) nextInput.focus();
        }
    });

    // ========== è²¼ä¸ŠåŠŸèƒ½æ ¸å¿ƒ ==========
    document.addEventListener('paste', e => {
        const el = document.activeElement;
        if (!el || el.readOnly || el.tagName !== 'INPUT') return;
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (!text.includes('\t') && !text.includes('\n')) return;
        e.preventDefault();
        saveState(); // è²¼ä¸Šå‰å„²å­˜ç‹€æ…‹
        const rowsData = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        const startTr = el.closest('tr'), tbody = startTr?.parentNode;
        if (!tbody || !tbody.id?.startsWith('tbody-')) return;
        const type = tbody.id.replace('tbody-', '');
        const colIdx = Array.from(startTr.children).indexOf(el.closest('td')), rowIdx = Array.from(tbody.children).indexOf(startTr);
        rowsData.forEach((rowStr, i) => {
            let targetTr = tbody.children[rowIdx + i];
            if (!targetTr) { mgr_addRow(type); targetTr = tbody.lastElementChild; }
            rowStr.split('\t').forEach((val, j) => {
                const input = targetTr.children[colIdx + j]?.querySelector('input:not([readonly])');
                if (input) { 
                    input.value = val.trim().replace(/,/g, ''); 
                    input.dispatchEvent(new Event('input', {bubbles:true})); 
                }
            });
        });
        debouncedSave();
    });

    // ========== åŒ¯å…¥/åŒ¯å‡º ==========
    function mgr_handleImport(files) {
        const file = files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                const content = e.target.result;
                if (file.name.endsWith('.json')) { 
                    const data = JSON.parse(content);
                    if (!data || typeof data !== 'object') throw new Error('Invalid JSON structure');
                    if (!data.sections || !Array.isArray(data.sections)) throw new Error('Invalid sections data');
                    mgr_populate(data); 
                }
                else {
                    const doc = new DOMParser().parseFromString(content, 'text/html');
                    const data = {
                        metadata: { org: doc.getElementById('mgr-org')?.value, year: doc.getElementById('mgr-year')?.value },
                        sections: sectionConfigs.map(conf => ({ id: conf.id, items: Array.from(doc.querySelectorAll(`#tbody-${conf.id} tr`)).map(tr => {
                            let item = {}; conf.fields.forEach(f => { const inp = tr.querySelector('.v-'+f); item[f] = inp?.getAttribute('value') || inp?.value || ''; });
                            return item;
                        }).filter(i => i.name) }))
                    };
                    mgr_populate(data);
                }
            } catch (err) {
                alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤\n' + err.message);
            }
        };
        r.readAsText(file);
    }

    function mgr_populate(data, shouldSaveState = true) {
        if (shouldSaveState) saveState();
        document.getElementById('mgr-org').value = data.metadata?.org || '';
        document.getElementById('mgr-year').value = data.metadata?.year || '115';
        document.getElementById('mgr-user').value = data.metadata?.user || '';
        sectionConfigs.forEach(conf => {
            const tbody = document.getElementById(`tbody-${conf.id}`);
            if (!tbody) return;
            tbody.innerHTML = '';
            const section = data.sections?.find(s => s.id === conf.id);
            if (section && section.items?.length > 0) {
                section.items.forEach(i => mgr_addRow(conf.id, i));
            } else {
                mgr_addRow(conf.id);
            }
            update(conf.id);
        });
        if (shouldSaveState) debouncedSave();
    }

    function mgr_exportXLSX() {
        try {
            const sheetData = []; 
            sectionConfigs.forEach(conf => {
                sheetData.push([conf.title]);
                sheetData.push(conf.fields.map(f => fieldNames[f]));
                Array.from(document.querySelectorAll(`#tbody-${conf.id} tr`)).forEach(tr => {
                    sheetData.push(conf.fields.map((f, idx) => {
                        const val = tr.querySelector('.v-'+f)?.value || '';
                        return idx === 0 ? val : { v: parseFloat(val) || 0, t: 'n', z: '#,##0' };
                    }));
                });
                const footRow = ["åˆè¨ˆ"];
                conf.fields.slice(1).forEach(f => footRow.push({ v: parseFloat(document.querySelector(`#tfoot-${conf.id} .t-${f}`)?.value.replace(/,/g, '')) || 0, t: 'n', z: '#,##0' }));
                sheetData.push(footRow, []); 
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "é ç®—ç¸½è¡¨");
            XLSX.writeFile(wb, "é ç®—å ±è¡¨.xlsx");
        } catch (err) {
            alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
        }
    }

    function mgr_exportJSON() {
        try {
            const data = collectData();
            const orgName = data.metadata.org || 'æœªå‘½å';
            saveAs(new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}), `${orgName}_é ç®—.json`);
        } catch (err) {
            alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
        }
    }

    function mgr_exportHTML() {
        try {
            document.querySelectorAll('input').forEach(i => i.setAttribute('value', i.value));
            saveAs(new Blob(["<!DOCTYPE html>\n" + document.documentElement.outerHTML], {type: "text/html"}), "é ç®—å‚™ä»½.html");
        } catch (err) {
            alert('åŒ¯å‡ºå¤±æ•—ï¼š' + err.message);
        }
    }

    function mgr_clearAll() { 
        if(confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ\nï¼ˆæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼‰')) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload(); 
        }
    }

    // ========== åŒ¯æ•´ç«¯åŠŸèƒ½ ==========
    let agg_data = [];

    function agg_setupDrag() {
        const dropzone = document.getElementById('agg-dropzone');
        if (!dropzone) return;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
        });

        dropzone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            Array.from(files).forEach(file => agg_processFile(file));
        });

        dropzone.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.html';
            input.multiple = true;
            input.onchange = e => Array.from(e.target.files).forEach(file => agg_processFile(file));
            input.click();
        });
    }

    function agg_processFile(file) {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                let data;
                if (file.name.endsWith('.json')) {
                    data = JSON.parse(e.target.result);
                    if (!data || typeof data !== 'object') throw new Error('Invalid JSON structure');
                    if (!data.sections || !Array.isArray(data.sections)) throw new Error('Invalid sections data');
                } else {
                    const doc = new DOMParser().parseFromString(e.target.result, 'text/html');
                    data = {
                        metadata: { org: doc.getElementById('mgr-org')?.value || file.name },
                        sections: sectionConfigs.map(conf => ({ 
                            id: conf.id, 
                            items: Array.from(doc.querySelectorAll(`#tbody-${conf.id} tr`)).map(tr => {
                                let item = {}; 
                                conf.fields.forEach(f => { 
                                    const inp = tr.querySelector('.v-'+f); 
                                    item[f] = inp?.getAttribute('value') || inp?.value || ''; 
                                });
                                return item;
                            }).filter(i => i.name) 
                        }))
                    };
                }
                agg_data.push(data);
                agg_render();
            } catch (err) {
                alert('è™•ç†æª”æ¡ˆå¤±æ•—ï¼š' + err.message);
            }
        };
        reader.readAsText(file);
    }

    function agg_render() {
        document.getElementById('agg-content').classList.remove('hidden');
        
        // è¨ˆç®— KPI
        let totalOrgs = agg_data.length;
        let totalFunds = 0;
        let totalNet = 0;
        
        agg_data.forEach(d => {
            d.sections?.forEach(s => {
                totalFunds += s.items?.length || 0;
                s.items?.forEach(item => {
                    totalNet += parseFloat(item.net) || parseFloat(item.end) || 0;
                });
            });
        });

        document.getElementById('agg-kpi').innerHTML = `
            <div class="kpi-card"><div class="text-slate-400 text-sm">å·²åŒ¯å…¥æ©Ÿé—œ</div><div class="kpi-value text-blue-400">${totalOrgs}</div></div>
            <div class="kpi-card"><div class="text-slate-400 text-sm">åŸºé‡‘ç¸½æ•¸</div><div class="kpi-value text-green-400">${totalFunds}</div></div>
            <div class="kpi-card"><div class="text-slate-400 text-sm">æ·¨é¡åˆè¨ˆ</div><div class="kpi-value ${totalNet < 0 ? 'text-red-400' : 'text-emerald-400'}">${totalNet.toLocaleString()}</div></div>
            <div class="kpi-card"><div class="text-slate-400 text-sm">åŒ¯æ•´æ™‚é–“</div><div class="kpi-value text-purple-400 text-lg">${new Date().toLocaleTimeString()}</div></div>
        `;

        // åˆ—è¡¨
        document.getElementById('agg-list-body').innerHTML = agg_data.map((d, i) => `
            <tr class="border-b border-slate-700">
                <td class="py-3 text-slate-400">${i+1}</td>
                <td class="py-3 font-bold">${escapeHtml(d.metadata?.org || 'æœªå‘½å')}</td>
                <td class="py-3">${d.sections?.reduce((sum, s) => sum + (s.items?.length || 0), 0) || 0} ç­†åŸºé‡‘</td>
                <td class="py-3"><button onclick="agg_data.splice(${i},1);agg_render();" class="text-red-400 hover:text-red-300">ç§»é™¤</button></td>
            </tr>
        `).join('');
    }

    function agg_clearAll() { 
        agg_data = []; 
        document.getElementById('agg-content').classList.add('hidden'); 
    }

    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => { 
        render(); 
        agg_setupDrag(); 
        
        // å˜—è©¦å¾ localStorage è¼‰å…¥
        const loaded = loadFromStorage();
        if (!loaded) {
            // æ²’æœ‰å„²å­˜è³‡æ–™ï¼Œåˆå§‹åŒ–ç©ºç™½åˆ—
            sectionConfigs.forEach(c => mgr_addRow(c.id)); 
        }
        
        // åˆå§‹åŒ– undo stack
        saveState();
        
        // ç›£è½ metadata æ¬„ä½è®Šæ›´
        ['mgr-org', 'mgr-year', 'mgr-user'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', debouncedSave);
        });
    });
</script>
</body>
</html>
